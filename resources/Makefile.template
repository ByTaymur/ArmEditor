include Makefile.cubemx

PROFILE ?= debug

ifeq ($(PROFILE),debug)
override OPT := -O0
override CFLAGS += -g3 -gdwarf-4
override CFLAGS += -fno-eliminate-unused-debug-types
override CFLAGS += -fno-inline
override CFLAGS += -fno-inline-functions
override DEBUG := 1
endif

ifeq ($(PROFILE),release)
override OPT := -O2 -flto
override LDFLAGS += -flto
override DEBUG := 0
endif

ifeq ($(PROFILE),O0)
override OPT := -O0
override DEBUG := 1
endif

ifeq ($(PROFILE),Og)
override OPT := -Og
override DEBUG := 1
endif

ifeq ($(PROFILE),O2)
override OPT := -O2 -flto
override DEBUG := 0
endif

ifeq ($(PROFILE),O3)
override OPT := -O3 -flto
override DEBUG := 0
endif

ifeq ($(PROFILE),Os)
override OPT := -Os -flto
override DEBUG := 0
endif

override CFLAGS += -fstack-usage
override LDFLAGS += -Wl,-Map=$(BUILD_DIR)/$(TARGET).map

MCU_DEFINE := $(shell grep -oP 'STM32\w+' Makefile.cubemx 2>/dev/null | head -1)
MCU_FAMILY := $(shell echo $(MCU_DEFINE) | grep -oP 'STM32[FGHLUWf][0-9]')

ifeq ($(MCU_FAMILY),STM32F0)
OPENOCD_TARGET = stm32f0x.cfg
else ifeq ($(MCU_FAMILY),STM32F1)
OPENOCD_TARGET = stm32f1x.cfg
else ifeq ($(MCU_FAMILY),STM32F2)
OPENOCD_TARGET = stm32f2x.cfg
else ifeq ($(MCU_FAMILY),STM32F3)
OPENOCD_TARGET = stm32f3x.cfg
else ifeq ($(MCU_FAMILY),STM32F4)
OPENOCD_TARGET = stm32f4x.cfg
else ifeq ($(MCU_FAMILY),STM32F7)
OPENOCD_TARGET = stm32f7x.cfg
else ifeq ($(MCU_FAMILY),STM32G0)
OPENOCD_TARGET = stm32g0x.cfg
else ifeq ($(MCU_FAMILY),STM32G4)
OPENOCD_TARGET = stm32g4x.cfg
else ifeq ($(MCU_FAMILY),STM32H7)
OPENOCD_TARGET = stm32h7x.cfg
else ifeq ($(MCU_FAMILY),STM32L0)
OPENOCD_TARGET = stm32l0.cfg
else ifeq ($(MCU_FAMILY),STM32L1)
OPENOCD_TARGET = stm32l1.cfg
else ifeq ($(MCU_FAMILY),STM32L4)
OPENOCD_TARGET = stm32l4x.cfg
else ifeq ($(MCU_FAMILY),STM32L5)
OPENOCD_TARGET = stm32l5x.cfg
else ifeq ($(MCU_FAMILY),STM32U5)
OPENOCD_TARGET = stm32u5x.cfg
else ifeq ($(MCU_FAMILY),STM32WB)
OPENOCD_TARGET = stm32wbx.cfg
else ifeq ($(MCU_FAMILY),STM32WL)
OPENOCD_TARGET = stm32wlx.cfg
else
OPENOCD_TARGET = stm32f4x.cfg
endif

DEBUGGER_CFG := interface/stlink.cfg

.PHONY: connect debug release O0 Og O2 O3 Os flash full-flash erase reset size

connect:
	@echo "ğŸ”Œ Testing..."
	@openocd -f $(DEBUGGER_CFG) -f target/$(OPENOCD_TARGET) -c "init" -c "targets" -c "exit" 2>&1 | grep -q "Cortex" && echo "âœ… Connected!" || echo "âŒ Failed!"

debug:
	@echo "ğŸ› Building DEBUG (-O0)..."
	@$(MAKE) clean
	@$(MAKE) PROFILE=debug -j$(shell nproc)
	@echo "âœ… Done!"

release:
	@echo "ğŸ“¦ Building RELEASE..."
	@$(MAKE) clean
	@$(MAKE) PROFILE=release -j$(shell nproc)
	@echo "âœ… Done!"

O0:
	@echo "âš¡ Building O0..."
	@$(MAKE) clean
	@$(MAKE) PROFILE=O0 -j$(shell nproc)
	@echo "âœ… Done!"

Og:
	@echo "ğŸ› Building Og..."
	@$(MAKE) clean
	@$(MAKE) PROFILE=Og -j$(shell nproc)
	@echo "âœ… Done!"

O2:
	@echo "âš™ï¸ Building O2..."
	@$(MAKE) clean
	@$(MAKE) PROFILE=O2 -j$(shell nproc)
	@echo "âœ… Done!"

O3:
	@echo "ğŸš€ Building O3..."
	@$(MAKE) clean
	@$(MAKE) PROFILE=O3 -j$(shell nproc)
	@echo "âœ… Done!"

Os:
	@echo "ğŸ“¦ Building Os..."
	@$(MAKE) clean
	@$(MAKE) PROFILE=Os -j$(shell nproc)
	@echo "âœ… Done!"

flash: connect
	@openocd -f $(DEBUGGER_CFG) -f target/$(OPENOCD_TARGET) -c "transport select hla_swd" -c "init" -c "reset halt" -c "flash write_image erase $(BUILD_DIR)/$(TARGET).elf" -c "reset run" -c "exit" && echo "âœ… Flashed!"

full-flash: debug flash reset

erase: connect
	@openocd -f $(DEBUGGER_CFG) -f target/$(OPENOCD_TARGET) -c "init" -c "reset halt" -c "flash erase_sector 0 0 last" -c "exit" && echo "âœ… Erased!"

reset: connect
	@openocd -f $(DEBUGGER_CFG) -f target/$(OPENOCD_TARGET) -c "init" -c "reset run" -c "exit" && echo "âœ… Reset!"

size:
	@$(SZ) -A $(BUILD_DIR)/$(TARGET).elf
