<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmEditor - Professional ARM IDE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            overflow: hidden;
            height: 100vh;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Toolbar */
        .toolbar {
            background: #2d2d30;
            padding: 8px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background: #1177bb;
        }

        .btn.success {
            background: #107c10;
        }

        .btn.success:hover {
            background: #13a10e;
        }

        .btn.danger {
            background: #c5000b;
        }

        .btn.danger:hover {
            background: #e81123;
        }

        .separator {
            width: 1px;
            height: 24px;
            background: #3e3e42;
        }

        /* Main area */
        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: #252526;
            border-right: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 12px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            font-weight: 600;
            font-size: 13px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .project-name {
            padding: 8px;
            background: #37373d;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        /* Editor */
        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .tabs {
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            min-height: 36px;
        }

        .tab {
            padding: 8px 16px;
            cursor: pointer;
            border-right: 1px solid #3e3e42;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab.active {
            background: #1e1e1e;
        }

        .tab:hover {
            background: #2a2d2e;
        }

        #editor {
            flex: 1;
            background: #1e1e1e;
        }

        .welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
        }

        .welcome h1 {
            font-size: 32px;
            margin-bottom: 16px;
            color: #ffffff;
        }

        .welcome p {
            font-size: 16px;
            color: #cccccc;
            margin-bottom: 32px;
        }

        .welcome-actions {
            display: flex;
            gap: 16px;
        }

        /* Output */
        .output {
            height: 200px;
            background: #1e1e1e;
            border-top: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
        }

        .output-tabs {
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            display: flex;
        }

        .output-tab {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .output-tab.active {
            background: #1e1e1e;
            border-bottom: 2px solid #007acc;
        }

        .output-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
        }

        /* Status bar */
        .statusbar {
            background: #007acc;
            color: white;
            padding: 4px 12px;
            display: flex;
            justify-content: space-between;
            font-size: 11px;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            width: 600px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .modal-header {
            background: #1e1e1e;
            padding: 16px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 16px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: #d4d4d4;
            font-size: 20px;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: 60vh;
        }

        .modal-section {
            margin-bottom: 20px;
        }

        .modal-section h3 {
            font-size: 13px;
            color: #569cd6;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #3e3e42;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #252526;
        }

        .info-label {
            color: #9cdcfe;
            font-size: 12px;
        }

        .info-value {
            color: #ce9178;
            font-size: 12px;
            font-family: 'Consolas', monospace;
        }

        .info-value.success {
            color: #4ec9b0;
        }

        .info-value.error {
            color: #f14c4c;
        }

        .settings-group {
            margin-bottom: 15px;
        }

        .settings-group label {
            display: block;
            font-size: 12px;
            color: #cccccc;
            margin-bottom: 5px;
        }

        .settings-group select,
        .settings-group input {
            width: 100%;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .settings-group select:focus,
        .settings-group input:focus {
            outline: none;
            border-color: #007acc;
        }

        .modal-footer {
            padding: 16px;
            border-top: 1px solid #3e3e42;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-secondary {
            background: #3e3e42;
            color: #d4d4d4;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-secondary:hover {
            background: #4e4e52;
        }

        /* Debug Panel Styles */
        .debug-panel {
            display: none;
            width: 300px;
            background: #252526;
            border-left: 1px solid #3e3e42;
            flex-direction: column;
        }

        .debug-panel.active {
            display: flex;
        }

        .debug-section {
            border-bottom: 1px solid #3e3e42;
        }

        .debug-section-header {
            padding: 8px 12px;
            background: #2d2d30;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }

        .debug-section-content {
            padding: 8px;
            font-size: 11px;
            font-family: 'Consolas', monospace;
            max-height: 150px;
            overflow-y: auto;
        }

        .watch-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #1e1e1e;
        }

        .watch-name {
            color: #9cdcfe;
        }

        .watch-value {
            color: #ce9178;
        }

        .watch-type {
            color: #4ec9b0;
            font-size: 10px;
        }

        .register-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
        }

        .register-name {
            color: #dcdcaa;
        }

        .register-value {
            color: #b5cea8;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4e4e4e;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Toolbar -->
        <div class="toolbar">
            <button class="btn" onclick="openFile()">üìÇ Open File</button>
            <button class="btn" onclick="openProject()">üìÅ Open Project</button>
            <button class="btn" onclick="saveFile()">üíæ Save</button>
            <div class="separator"></div>
            <button class="btn success" onclick="buildProject()">üî® Build (F7)</button>
            <button class="btn" onclick="cleanProject()">üßπ Clean</button>
            <div class="separator"></div>
            <button class="btn success" onclick="flashDevice()">‚ö° Flash</button>
            <div class="separator"></div>
            <button class="btn" onclick="analyzeCode()">ü§ñ AI Analyze</button>
            <div class="separator"></div>
            <button class="btn" onclick="openTargetSetup()">‚öôÔ∏è Target Setup</button>
            <button class="btn" onclick="openCompilerSettings()">üîß Compiler</button>
        </div>

        <!-- Main -->
        <div class="main">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">PROJECT</div>
                <div class="sidebar-content">
                    <div id="project-info" class="project-name">No project opened</div>
                    <div id="file-info"></div>
                </div>
            </div>

            <!-- Editor -->
            <div class="editor-area">
                <div class="tabs" id="tabs"></div>
                <div id="editor-container">
                    <div class="welcome" id="welcome">
                        <h1>üöÄ ArmEditor</h1>
                        <p>Professional ARM Development IDE<br>Better than Keil/IAR, completely free!</p>
                        <div class="welcome-actions">
                            <button class="btn" onclick="openFile()">Open File</button>
                            <button class="btn success" onclick="openProject()">Open Project</button>
                        </div>
                    </div>
                    <div id="editor" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Output -->
        <div class="output">
            <div class="output-tabs">
                <div class="output-tab active">OUTPUT</div>
            </div>
            <div class="output-content" id="output"></div>
        </div>

        <!-- Status bar -->
        <div class="statusbar">
            <div id="status-left">Ready</div>
            <div id="status-right">ArmEditor v1.0.0</div>
        </div>
    </div>

    <!-- Target Setup Modal -->
    <div class="modal-overlay" id="targetSetupModal">
        <div class="modal">
            <div class="modal-header">
                <h2>‚öôÔ∏è Cortex-M Target Driver Setup</h2>
                <button class="modal-close" onclick="closeTargetSetup()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="modal-section">
                    <h3>üîå Debug Adapter</h3>
                    <div class="info-row">
                        <span class="info-label">Adapter Type</span>
                        <span class="info-value" id="adapter-type">Detecting...</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Serial Number</span>
                        <span class="info-value" id="adapter-serial">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Firmware Version</span>
                        <span class="info-value" id="adapter-firmware">-</span>
                    </div>
                </div>

                <div class="modal-section">
                    <h3>üéØ Target Detection</h3>
                    <div class="info-row">
                        <span class="info-label">IDCODE</span>
                        <span class="info-value success" id="target-idcode">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Device</span>
                        <span class="info-value" id="target-device">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Core</span>
                        <span class="info-value" id="target-core">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Flash Size</span>
                        <span class="info-value" id="target-flash">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">RAM Size</span>
                        <span class="info-value" id="target-ram">-</span>
                    </div>
                </div>

                <div class="modal-section">
                    <h3>‚ö° Debug Settings</h3>
                    <div class="settings-group">
                        <label>Clock Speed (kHz)</label>
                        <select id="debug-clock">
                            <option value="1000">1000 kHz</option>
                            <option value="4000" selected>4000 kHz</option>
                            <option value="8000">8000 kHz</option>
                            <option value="10000">10000 kHz</option>
                        </select>
                    </div>
                    <div class="settings-group">
                        <label>Reset Type</label>
                        <select id="reset-type">
                            <option value="hw">Hardware Reset</option>
                            <option value="sw" selected>Software Reset</option>
                            <option value="connect">Connect Under Reset</option>
                        </select>
                    </div>
                    <div class="settings-group">
                        <label>Interface</label>
                        <select id="debug-interface">
                            <option value="swd" selected>SWD</option>
                            <option value="jtag">JTAG</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="detectTarget()">üîç Re-detect</button>
                <button class="btn success" onclick="applyTargetSettings()">‚úì Apply</button>
            </div>
        </div>
    </div>

    <!-- Compiler Settings Modal -->
    <div class="modal-overlay" id="compilerSettingsModal">
        <div class="modal">
            <div class="modal-header">
                <h2>üîß Compiler Settings</h2>
                <button class="modal-close" onclick="closeCompilerSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="modal-section">
                    <h3>üõ†Ô∏è Toolchain</h3>
                    <div class="settings-group">
                        <label>ARM Compiler</label>
                        <select id="compiler-version">
                            <option value="gcc">ARM GCC (arm-none-eabi-gcc)</option>
                            <option value="clang">LLVM/Clang</option>
                        </select>
                    </div>
                    <div class="settings-group">
                        <label>CPU</label>
                        <select id="cpu-type">
                            <option value="cortex-m0">Cortex-M0</option>
                            <option value="cortex-m0plus">Cortex-M0+</option>
                            <option value="cortex-m3">Cortex-M3</option>
                            <option value="cortex-m4" selected>Cortex-M4</option>
                            <option value="cortex-m7">Cortex-M7</option>
                            <option value="cortex-m33">Cortex-M33</option>
                        </select>
                    </div>
                    <div class="settings-group">
                        <label>FPU</label>
                        <select id="fpu-type">
                            <option value="none">No FPU</option>
                            <option value="fpv4-sp-d16" selected>FPv4-SP-D16 (Single Precision)</option>
                            <option value="fpv5-sp-d16">FPv5-SP-D16</option>
                            <option value="fpv5-d16">FPv5-D16 (Double Precision)</option>
                        </select>
                    </div>
                </div>

                <div class="modal-section">
                    <h3>‚ö° Optimization</h3>
                    <div class="settings-group">
                        <label>Optimization Level</label>
                        <select id="opt-level">
                            <option value="-O0">-O0 (No Optimization - Debug)</option>
                            <option value="-O1">-O1 (Optimize)</option>
                            <option value="-O2" selected>-O2 (Optimize More)</option>
                            <option value="-O3">-O3 (Optimize Most)</option>
                            <option value="-Os">-Os (Optimize Size)</option>
                            <option value="-Ofast">-Ofast (Fast - Unsafe)</option>
                        </select>
                    </div>
                    <div class="settings-group">
                        <label>Debug Level</label>
                        <select id="debug-level">
                            <option value="-g0">-g0 (No Debug Info)</option>
                            <option value="-g1">-g1 (Minimal)</option>
                            <option value="-g2">-g2 (Default)</option>
                            <option value="-g3" selected>-g3 (Maximum Debug Info)</option>
                        </select>
                    </div>
                </div>

                <div class="modal-section">
                    <h3>üìù Preprocessor Defines</h3>
                    <div class="settings-group">
                        <label>Defines (one per line)</label>
                        <textarea id="preprocessor-defines" style="width:100%; height:80px; background:#1e1e1e; border:1px solid #3e3e42; color:#d4d4d4; padding:8px; border-radius:4px; font-family:Consolas,monospace; font-size:12px;">USE_HAL_DRIVER
STM32F4xx
HSE_VALUE=8000000</textarea>
                    </div>
                </div>

                <div class="modal-section">
                    <h3>üìÅ Include Paths</h3>
                    <div class="settings-group">
                        <label>Include Paths (one per line)</label>
                        <textarea id="include-paths" style="width:100%; height:60px; background:#1e1e1e; border:1px solid #3e3e42; color:#d4d4d4; padding:8px; border-radius:4px; font-family:Consolas,monospace; font-size:12px;">./inc
./Drivers/CMSIS/Include
./Drivers/STM32F4xx_HAL_Driver/Inc</textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeCompilerSettings()">Cancel</button>
                <button class="btn success" onclick="applyCompilerSettings()">‚úì Apply</button>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');

        let editor = null;
        let currentFile = null;

        // Load Monaco Editor from CDN
        const loaderScript = document.createElement('script');
        loaderScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js';
        loaderScript.onload = () => {
            require.config({
                paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }
            });
            require(['vs/editor/editor.main'], initMonaco);
        };
        document.head.appendChild(loaderScript);

        function initMonaco() {
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: '',
                language: 'c',
                theme: 'vs-dark',
                automaticLayout: true,
                fontSize: 14,
                minimap: { enabled: true }
            });

            outputAppend('‚úÖ Editor ready\n');
        }

        // IPC Listeners
        ipcRenderer.on('new-file', () => {
            if (editor) {
                editor.setValue('');
                currentFile = null;
                updateUI();
            }
        });

        ipcRenderer.on('open-file', (event, data) => {
            if (editor) {
                editor.setValue(data.content);
                currentFile = data;
                updateUI();
                document.getElementById('welcome').style.display = 'none';
                document.getElementById('editor').style.display = 'block';
            }
        });

        ipcRenderer.on('open-project', (event, data) => {
            document.getElementById('project-info').textContent = data.path;
            outputAppend(`üìÅ Opened project: ${data.path}\n`);
        });

        ipcRenderer.on('get-editor-content', (event, action) => {
            if (editor) {
                const content = editor.getValue();
                if (action === 'save') {
                    ipcRenderer.send('save-file-content', content);
                } else if (action === 'save-as') {
                    ipcRenderer.send('save-file-as-content', content);
                }
            }
        });

        ipcRenderer.on('file-saved', (event, path) => {
            outputAppend(`üíæ Saved: ${path}\n`);
        });

        ipcRenderer.on('output-clear', () => {
            document.getElementById('output').textContent = '';
        });

        ipcRenderer.on('output-append', (event, text) => {
            outputAppend(text);
        });

        // UI Functions
        function openFile() {
            ipcRenderer.send('open-file-dialog');
        }

        function openProject() {
            ipcRenderer.send('open-project-dialog');
        }

        function saveFile() {
            if (editor) {
                ipcRenderer.send('get-editor-content', 'save');
            }
        }

        function buildProject() {
            outputAppend('\nüî® Building...\n');
        }

        function cleanProject() {
            outputAppend('üßπ Cleaning...\n');
        }

        function flashDevice() {
            outputAppend('‚ö° Flashing...\n');
        }

        function analyzeCode() {
            outputAppend('\nü§ñ Running AI analysis...\n');
        }

        function outputAppend(text) {
            const output = document.getElementById('output');
            output.textContent += text;
            output.scrollTop = output.scrollHeight;
        }

        function updateUI() {
            if (currentFile) {
                document.getElementById('file-info').innerHTML =
                    `<div style="padding: 8px; font-size: 12px;">
                        üìÑ ${currentFile.name}
                    </div>`;
            }
        }

        // Initial message
        outputAppend('ArmEditor - Professional ARM IDE\n');
        outputAppend('Better than Keil/IAR, completely free!\n');
        outputAppend('Loading Monaco Editor...\n');

        // ============ TARGET SETUP MODAL ============
        let targetSettings = {
            adapter: null,
            idcode: null,
            device: null,
            clock: 4000,
            resetType: 'sw',
            interface: 'swd'
        };

        function openTargetSetup() {
            document.getElementById('targetSetupModal').classList.add('active');
            detectTarget();
        }

        function closeTargetSetup() {
            document.getElementById('targetSetupModal').classList.remove('active');
        }

        async function detectTarget() {
            outputAppend('\nüîç Detecting target...\n');

            document.getElementById('adapter-type').textContent = 'Detecting...';
            document.getElementById('target-idcode').textContent = 'Scanning...';

            // Simulate ST-Link detection via st-info or OpenOCD
            const { exec } = require('child_process');

            // Try st-info first (STM32 tools)
            exec('st-info --probe 2>/dev/null || echo "no-stlink"', (error, stdout, stderr) => {
                if (stdout.includes('no-stlink') || error) {
                    // Try OpenOCD detection
                    detectWithOpenOCD();
                } else {
                    parseSTLinkInfo(stdout);
                }
            });
        }

        function parseSTLinkInfo(output) {
            const lines = output.split('\n');
            let serial = '-';
            let version = '-';
            let chipId = '-';
            let flash = '-';
            let sram = '-';
            let device = 'Unknown';

            lines.forEach(line => {
                if (line.includes('serial:')) {
                    serial = line.split('serial:')[1]?.trim() || '-';
                }
                if (line.includes('flash:')) {
                    flash = line.split('flash:')[1]?.trim() || '-';
                }
                if (line.includes('sram:')) {
                    sram = line.split('sram:')[1]?.trim() || '-';
                }
                if (line.includes('chipid:')) {
                    chipId = line.split('chipid:')[1]?.trim() || '-';
                }
                if (line.includes('descr:')) {
                    device = line.split('descr:')[1]?.trim() || 'Unknown';
                }
            });

            updateTargetUI({
                adapterType: 'ST-LINK/V2',
                serial: serial,
                firmware: version,
                idcode: chipId,
                device: device,
                core: 'ARM Cortex-M',
                flash: flash,
                ram: sram
            });
        }

        function detectWithOpenOCD() {
            const { exec } = require('child_process');

            // OpenOCD one-shot detection
            const cmd = 'timeout 3 openocd -f interface/stlink.cfg -f target/stm32f4x.cfg -c "init; targets; exit" 2>&1 || echo "detection-failed"';

            exec(cmd, (error, stdout, stderr) => {
                if (stdout.includes('detection-failed') || error) {
                    // No hardware detected - show simulated values for demo
                    updateTargetUI({
                        adapterType: 'ST-LINK/V3 (Demo)',
                        serial: '003400343...',
                        firmware: 'V3J9M3B5S1',
                        idcode: '0x5BA02477',
                        device: 'STM32F7x7',
                        core: 'ARM Cortex-M7',
                        flash: '2048 KB',
                        ram: '512 KB'
                    });
                    outputAppend('‚ö†Ô∏è No hardware detected - showing demo values\n');
                } else {
                    // Parse OpenOCD output
                    parseOpenOCDOutput(stdout);
                }
            });
        }

        function parseOpenOCDOutput(output) {
            let idcode = '-';
            let device = 'Unknown';

            // Look for IDCODE in output
            const idcodeMatch = output.match(/IDCODE[:\s]+([0-9a-fA-Fx]+)/i);
            if (idcodeMatch) {
                idcode = idcodeMatch[1];
            }

            // Detect device from IDCODE
            const deviceMap = {
                '0x1BA01477': { name: 'STM32F1xx', core: 'Cortex-M3' },
                '0x2BA01477': { name: 'STM32F4xx', core: 'Cortex-M4' },
                '0x5BA02477': { name: 'STM32F7xx', core: 'Cortex-M7' },
                '0x6BA02477': { name: 'STM32H7xx', core: 'Cortex-M7' },
            };

            const detected = deviceMap[idcode] || { name: 'Unknown', core: 'Cortex-M' };

            updateTargetUI({
                adapterType: 'ST-LINK',
                serial: '-',
                firmware: '-',
                idcode: idcode,
                device: detected.name,
                core: detected.core,
                flash: '-',
                ram: '-'
            });
        }

        function updateTargetUI(info) {
            document.getElementById('adapter-type').textContent = info.adapterType;
            document.getElementById('adapter-type').className = 'info-value success';
            document.getElementById('adapter-serial').textContent = info.serial;
            document.getElementById('adapter-firmware').textContent = info.firmware;
            document.getElementById('target-idcode').textContent = info.idcode;
            document.getElementById('target-device').textContent = info.device;
            document.getElementById('target-core').textContent = info.core;
            document.getElementById('target-flash').textContent = info.flash;
            document.getElementById('target-ram').textContent = info.ram;

            targetSettings.idcode = info.idcode;
            targetSettings.device = info.device;

            outputAppend(`‚úÖ Target: ${info.device} (${info.idcode})\n`);
        }

        function applyTargetSettings() {
            targetSettings.clock = document.getElementById('debug-clock').value;
            targetSettings.resetType = document.getElementById('reset-type').value;
            targetSettings.interface = document.getElementById('debug-interface').value;

            outputAppend(`‚öôÔ∏è Target settings applied:\n`);
            outputAppend(`   Clock: ${targetSettings.clock} kHz\n`);
            outputAppend(`   Reset: ${targetSettings.resetType}\n`);
            outputAppend(`   Interface: ${targetSettings.interface}\n`);

            closeTargetSetup();
        }

        // ============ COMPILER SETTINGS MODAL ============
        let compilerSettings = {
            compiler: 'gcc',
            cpu: 'cortex-m4',
            fpu: 'fpv4-sp-d16',
            optLevel: '-O2',
            debugLevel: '-g3',
            defines: ['USE_HAL_DRIVER', 'STM32F4xx'],
            includePaths: ['./inc']
        };

        function openCompilerSettings() {
            document.getElementById('compilerSettingsModal').classList.add('active');
        }

        function closeCompilerSettings() {
            document.getElementById('compilerSettingsModal').classList.remove('active');
        }

        function applyCompilerSettings() {
            compilerSettings.compiler = document.getElementById('compiler-version').value;
            compilerSettings.cpu = document.getElementById('cpu-type').value;
            compilerSettings.fpu = document.getElementById('fpu-type').value;
            compilerSettings.optLevel = document.getElementById('opt-level').value;
            compilerSettings.debugLevel = document.getElementById('debug-level').value;
            compilerSettings.defines = document.getElementById('preprocessor-defines').value.split('\n').filter(d => d.trim());
            compilerSettings.includePaths = document.getElementById('include-paths').value.split('\n').filter(p => p.trim());

            outputAppend(`üîß Compiler settings applied:\n`);
            outputAppend(`   CPU: ${compilerSettings.cpu}\n`);
            outputAppend(`   FPU: ${compilerSettings.fpu}\n`);
            outputAppend(`   Optimization: ${compilerSettings.optLevel}\n`);
            outputAppend(`   Defines: ${compilerSettings.defines.length} items\n`);

            closeCompilerSettings();
        }

        // Close modals with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeTargetSetup();
                closeCompilerSettings();
            }
        });
    </script>
</body>
</html>
