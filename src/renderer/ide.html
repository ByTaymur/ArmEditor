<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HopeIDE - Professional ARM IDE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #cccccc;
            overflow: hidden;
            height: 100vh;
        }

        /* TOP MENU BAR */
        .top-menu {
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            height: 40px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 5px;
        }

        .menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 13px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .menu-item:hover {
            background: #3e3e42;
        }

        .menu-item.active {
            background: #094771;
        }

        /* MAIN CONTAINER */
        .main-container {
            display: flex;
            height: calc(100vh - 40px);
        }

        /* LEFT SIDEBAR */
        .sidebar {
            width: 60px;
            background: #252526;
            border-right: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
            gap: 5px;
        }

        .sidebar-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
            position: relative;
        }

        .sidebar-icon:hover {
            background: #2a2d2e;
        }

        .sidebar-icon.active {
            background: #094771;
        }

        .sidebar-icon::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 60px;
            background: #2d2d30;
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
        }

        .sidebar-icon:hover::after {
            opacity: 1;
        }

        /* CONTENT AREA */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .view {
            display: none;
            flex: 1;
            overflow: auto;
        }

        .view.active {
            display: flex;
            flex-direction: column;
        }

        /* ST-LINK VIEW */
        .stlink-view {
            padding: 20px;
            gap: 20px;
            overflow-y: auto;
        }

        .card {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title-icon {
            font-size: 20px;
        }

        /* CONNECTION PANEL */
        .connection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            color: #cccccc;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            color: #cccccc;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            border-color: #007acc;
        }

        select.form-control {
            cursor: pointer;
        }

        /* DEVICE LIST */
        .device-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .device-card {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: border-color 0.2s, background 0.2s;
        }

        .device-card:hover {
            border-color: #007acc;
            background: #2a2d2e;
        }

        .device-card.connected {
            border-color: #4ec9b0;
            background: #1a3329;
        }

        .device-info {
            flex: 1;
        }

        .device-name {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 5px;
        }

        .device-details {
            font-size: 12px;
            color: #858585;
        }

        .device-status {
            font-size: 12px;
            color: #4ec9b0;
            margin-top: 5px;
        }

        .device-card.connected .device-status {
            color: #4ec9b0;
        }

        /* BUTTONS */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            font-weight: 500;
            outline: none;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: #0e639c;
            color: #ffffff;
        }

        .btn-primary:hover {
            background: #1177bb;
        }

        .btn-success {
            background: #16825d;
            color: #ffffff;
        }

        .btn-success:hover {
            background: #1a9870;
        }

        .btn-danger {
            background: #a1260d;
            color: #ffffff;
        }

        .btn-danger:hover {
            background: #c72e0d;
        }

        .btn-secondary {
            background: #3e3e42;
            color: #cccccc;
        }

        .btn-secondary:hover {
            background: #4e4e52;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* MEMORY VIEW */
        .memory-view {
            padding: 20px;
        }

        .memory-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: flex-end;
        }

        .memory-table {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            overflow: hidden;
        }

        .memory-table table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px;
        }

        .memory-table th {
            background: #2d2d30;
            color: #ffffff;
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #3e3e42;
        }

        .memory-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #2d2d30;
        }

        .memory-table tr:hover {
            background: #2a2d2e;
        }

        .memory-address {
            color: #4ec9b0;
        }

        .memory-hex {
            color: #ce9178;
            font-family: monospace;
        }

        .memory-ascii {
            color: #858585;
        }

        /* FLASH DOWNLOAD VIEW */
        .flash-view {
            padding: 20px;
        }

        .file-drop-zone {
            background: #1e1e1e;
            border: 2px dashed #3e3e42;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            margin-bottom: 20px;
        }

        .file-drop-zone:hover {
            border-color: #007acc;
            background: #252526;
        }

        .file-drop-zone.drag-over {
            border-color: #4ec9b0;
            background: #1a3329;
        }

        .drop-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .drop-text {
            font-size: 14px;
            color: #cccccc;
            margin-bottom: 5px;
        }

        .drop-hint {
            font-size: 12px;
            color: #858585;
        }

        .file-info {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .file-info.active {
            display: block;
        }

        .file-info-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 13px;
        }

        .file-info-label {
            color: #858585;
        }

        .file-info-value {
            color: #ffffff;
            font-family: monospace;
        }

        .flash-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-group label {
            font-size: 13px;
            cursor: pointer;
            user-select: none;
        }

        .flash-actions {
            display: flex;
            gap: 10px;
        }

        /* OUTPUT CONSOLE */
        .output-console {
            background: #1e1e1e;
            border-top: 1px solid #3e3e42;
            height: 200px;
            display: flex;
            flex-direction: column;
        }

        .console-header {
            background: #2d2d30;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3e3e42;
        }

        .console-title {
            font-size: 13px;
            font-weight: 500;
        }

        .console-actions {
            display: flex;
            gap: 10px;
        }

        .console-btn {
            background: none;
            border: none;
            color: #cccccc;
            cursor: pointer;
            font-size: 16px;
            padding: 4px 8px;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .console-btn:hover {
            background: #3e3e42;
        }

        .console-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px 15px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
        }

        .console-line {
            margin-bottom: 2px;
        }

        .console-line.error {
            color: #f48771;
        }

        .console-line.success {
            color: #4ec9b0;
        }

        .console-line.warning {
            color: #dcdcaa;
        }

        /* STATUS BAR */
        .status-bar {
            background: #007acc;
            height: 24px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 12px;
            justify-content: space-between;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-icon {
            font-size: 14px;
        }

        /* EDITOR VIEW */
        .editor-view {
            display: flex;
            height: 100%;
        }

        .file-explorer {
            width: 250px;
            background: #252526;
            border-right: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
        }

        /* Debug Panel - Saƒü Sidebar */
        .debug-panel {
            width: 320px;
            background: #252526;
            border-left: 1px solid #3e3e42;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }

        .debug-panel.visible {
            display: flex;
        }

        .debug-section {
            border-bottom: 1px solid #3e3e42;
        }

        .debug-section-header {
            padding: 8px 12px;
            background: #2d2d30;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .debug-section-header:hover {
            background: #37373d;
        }

        .debug-section-content {
            padding: 8px;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .debug-section-content.collapsed {
            display: none;
        }

        .register-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }

        .register-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 4px;
            background: #1e1e1e;
            border-radius: 2px;
            font-family: 'Consolas', monospace;
            font-size: 11px;
        }

        .register-name {
            color: #9cdcfe;
        }

        .register-value {
            color: #ce9178;
        }

        .variable-item,
        .breakpoint-item {
            padding: 4px 8px;
            background: #1e1e1e;
            margin-bottom: 4px;
            border-radius: 2px;
            font-size: 11px;
        }

        .debug-toolbar {
            padding: 8px;
            background: #2d2d30;
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .debug-btn {
            background: #0e639c;
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .debug-btn:hover {
            background: #1177bb;
        }

        .debug-btn.success {
            background: #107c10;
        }

        .debug-btn.danger {
            background: #c5000b;
        }

        .debug-status {
            padding: 8px 12px;
            background: #1e1e1e;
            font-size: 11px;
            color: #888;
        }

        .debug-status.running {
            color: #4ec9b0;
        }

        .debug-status.stopped {
            color: #f48771;
        }

        .sidebar-header {
            padding: 12px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            font-size: 13px;
            font-weight: 600;
        }

        .file-tree {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .file-item,
        .folder-item {
            padding: 6px 16px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
        }

        .file-item:hover,
        .folder-item:hover {
            background: #2a2d2e;
        }

        .file-item.active {
            background: #094771;
            color: #ffffff;
        }

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .editor-tabs {
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            overflow-x: auto;
        }

        .editor-tab {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 13px;
            border-right: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            gap: 8px;
            background: #2d2d30;
            transition: background 0.2s;
        }

        .editor-tab:hover {
            background: #1e1e1e;
        }

        .editor-tab.active {
            background: #1e1e1e;
        }

        .tab-close {
            margin-left: 5px;
            opacity: 0.6;
        }

        .tab-close:hover {
            opacity: 1;
        }

        .code-editor {
            flex: 1;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            overflow: auto;
            resize: none;
            border: none;
            outline: none;
        }

        /* DEVICE INFO PANEL */
        .device-info-panel {
            background: #252526;
            border-left: 1px solid #3e3e42;
            width: 300px;
            padding: 20px;
            overflow-y: auto;
        }

        .info-section {
            margin-bottom: 20px;
        }

        .info-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 12px;
            border-bottom: 1px solid #2d2d30;
        }

        .info-label {
            color: #858585;
        }

        .info-value {
            color: #cccccc;
            font-family: monospace;
        }

        .connection-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .connection-indicator.connected {
            background: #4ec9b0;
            box-shadow: 0 0 6px #4ec9b0;
        }

        .connection-indicator.disconnected {
            background: #858585;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4e4e4e;
        }

        /* PROGRESS BAR */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #2d2d30;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
            display: none;
        }

        .progress-bar.active {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: #007acc;
            transition: width 0.3s;
            border-radius: 3px;
        }

        /* DEBUG STYLES */
        .btn-warning {
            background: #b89500;
            color: #ffffff;
        }

        .btn-warning:hover {
            background: #d4a900;
        }

        .btn-info {
            background: #0e7490;
            color: #ffffff;
        }

        .btn-info:hover {
            background: #1098b8;
        }

        .btn-sm {
            padding: 4px 12px;
            font-size: 12px;
        }

        .register-item {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
        }

        .register-item.highlight {
            border-color: #007acc;
            background: #1a2b3a;
        }

        .register-name {
            font-size: 11px;
            color: #858585;
            font-weight: 600;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .register-value {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #4ec9b0;
            font-weight: 500;
        }

        .debug-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .debug-table th {
            background: #2d2d30;
            color: #ffffff;
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #3e3e42;
            font-weight: 600;
        }

        .debug-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #2d2d30;
            color: #cccccc;
        }

        .debug-table tr:hover {
            background: #2a2d2e;
        }

        .breakpoint-item {
            padding: 10px;
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
        }

        .breakpoint-item:hover {
            background: #2a2d2e;
        }

        .callstack-item {
            padding: 10px;
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            margin-bottom: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .callstack-item:hover {
            background: #2a2d2e;
            cursor: pointer;
        }

        .callstack-function {
            color: #4ec9b0;
            font-weight: 600;
        }

        .callstack-location {
            color: #858585;
            font-size: 11px;
            margin-top: 4px;
        }

        .disassembly-line {
            padding: 4px 8px;
            display: flex;
            gap: 15px;
            font-family: 'Courier New', monospace;
        }

        .disassembly-line:hover {
            background: #2a2d2e;
        }

        .disassembly-line.current {
            background: #094771;
            border-left: 3px solid #007acc;
        }

        .disassembly-addr {
            color: #858585;
            min-width: 80px;
        }

        .disassembly-bytes {
            color: #b5cea8;
            min-width: 100px;
        }

        .disassembly-inst {
            color: #4ec9b0;
        }

        .variable-table-container {
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Toolbar -->
        <div class="toolbar">
            <button class="btn" onclick="openFile()">üìÇ Open File</button>
            <button class="btn" onclick="openProject()">üìÅ Open Project</button>
            <button class="btn" onclick="saveFile()">üíæ Save</button>
            <div class="separator"></div>
            <button class="btn success" onclick="buildProject()">üî® Build (F7)</button>
            <button class="btn" onclick="cleanProject()">üßπ Clean</button>
            <div class="separator"></div>
            <button class="btn success" onclick="flashDevice()">‚ö° Flash</button>
            <button class="btn" onclick="openTargetSettings()">‚öôÔ∏è Target Settings</button>
            <div class="separator"></div>
            <button class="btn success" onclick="startDebug()">‚ñ∂Ô∏è Debug (F5)</button>
            <button class="btn danger" onclick="stopDebug()">‚èπÔ∏è Stop</button>
            <div class="separator"></div>
            <button class="btn" onclick="toggleDebugPanel()">üîß Debug Panel</button>
            <button class="btn" onclick="analyzeCode()">ü§ñ AI Analyze</button>
        </div>

        <!-- Main -->
        <div class="main">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">PROJECT</div>
                <div class="sidebar-content">
                    <div id="project-info" class="project-name">No project opened</div>
                    <div id="file-tree" style="margin-top: 10px; overflow-y: auto; max-height: calc(100vh - 200px);">
                    </div>
                </div>
            </div>

            <!-- Editor -->
            <div class="editor-area">
                <div class="tabs" id="tabs"></div>
                <div id="editor-container">
                    <div class="welcome" id="welcome">
                        <h1>üöÄ ArmEditor</h1>
                        <p>Professional ARM Development IDE<br>Better than Keil/IAR, completely free!</p>
                        <div class="welcome-actions">
                            <button class="btn" onclick="openFile()">Open File</button>
                            <button class="btn success" onclick="openProject()">Open Project</button>
                        </div>
                    </div>
                    <div class="editor-container">
                        <div class="editor-tabs" id="editor-tabs">
                            <div class="editor-tab active">
                                <span>Welcome</span>
                            </div>
                        </div>
                        <textarea class="code-editor" id="code-editor"
                            placeholder="Select a file to edit..."></textarea>
                    </div>
                </div>
            </div>

            <!-- ST-LINK VIEW -->
            <div class="view stlink-view" id="stlink-view">
                <!-- CONNECTION SETTINGS -->
                <div class="card">
                    <div class="card-title">
                        <span class="card-title-icon">üîå</span>
                        ST-Link Connection Settings
                    </div>
                    <div class="connection-grid">
                        <div>
                            <div class="form-group">
                                <label class="form-label">Debug Interface</label>
                                <select class="form-control" id="debug-interface">
                                    <option value="swd">SWD (Serial Wire Debug)</option>
                                    <option value="jtag">JTAG</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Frequency (kHz)</label>
                                <select class="form-control" id="debug-frequency">
                                    <option value="5">5 kHz</option>
                                    <option value="25">25 kHz</option>
                                    <option value="100">100 kHz</option>
                                    <option value="240">240 kHz</option>
                                    <option value="950">950 kHz</option>
                                    <option value="1800" selected>1800 kHz</option>
                                    <option value="4000">4000 kHz</option>
                                    <option value="8000">8000 kHz</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label class="form-label">Reset Mode</label>
                                <select class="form-control" id="reset-mode">
                                    <option value="software">Software System Reset</option>
                                    <option value="hardware">Hardware Reset (nRST)</option>
                                    <option value="core">Core Reset</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Connection Mode</label>
                                <select class="form-control" id="connection-mode">
                                    <option value="normal">Normal</option>
                                    <option value="hotplug">Hot Plug</option>
                                    <option value="under-reset">Connect Under Reset</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label class="form-label">Shared Mode</label>
                                <select class="form-control" id="shared-mode">
                                    <option value="disabled">Disabled</option>
                                    <option value="enabled">Enabled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Target MCU (Auto-Detected)</label>
                                <select class="form-control" id="target-mcu">
                                    <option value="auto" selected>üîç Auto-Detect MCU</option>
                                    <option value="stm32f0x">STM32F0xx</option>
                                    <option value="stm32f1x">STM32F1xx</option>
                                    <option value="stm32f2x">STM32F2xx</option>
                                    <option value="stm32f3x">STM32F3xx</option>
                                    <option value="stm32f4x">STM32F4xx</option>
                                    <option value="stm32f7x">STM32F7xx</option>
                                    <option value="stm32g0x">STM32G0xx</option>
                                    <option value="stm32g4x">STM32G4xx</option>
                                    <option value="stm32h7x">STM32H7xx</option>
                                    <option value="stm32l0x">STM32L0xx</option>
                                    <option value="stm32l1x">STM32L1xx</option>
                                    <option value="stm32l4x">STM32L4xx</option>
                                    <option value="stm32l5x">STM32L5xx</option>
                                    <option value="stm32wbx">STM32WBxx</option>
                                    <option value="stm32wlx">STM32WLxx</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="refreshDevices()">üîÑ Refresh Devices</button>
                </div>

                <!-- DEVICE LIST -->
                <div class="card">
                    <div class="card-title">
                        <span class="card-title-icon">üì±</span>
                        Connected Devices
                    </div>
                    <div class="device-list" id="device-list">
                        <div style="padding: 20px; text-align: center; color: #858585;">
                            Click "Refresh Devices" to scan for ST-Link
                        </div>
                    </div>
                </div>
            </div>

            <!-- MEMORY VIEW -->
            <div class="view memory-view" id="memory-view">
                <div class="card">
                    <div class="card-title">
                        <span class="card-title-icon">üíæ</span>
                        Memory Browser
                    </div>
                    <div class="memory-controls">
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Start Address (Hex)</label>
                            <input type="text" class="form-control" id="memory-address" value="0x08000000"
                                style="width: 150px;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Size (bytes)</label>
                            <input type="number" class="form-control" id="memory-size" value="256"
                                style="width: 120px;">
                        </div>
                        <button class="btn btn-primary" onclick="readMemory()">üìñ Read</button>
                        <button class="btn btn-secondary" onclick="saveMemory()">üíæ Save to File</button>
                    </div>
                    <div class="memory-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Address</th>
                                    <th>+0</th>
                                    <th>+1</th>
                                    <th>+2</th>
                                    <th>+3</th>
                                    <th>+4</th>
                                    <th>+5</th>
                                    <th>+6</th>
                                    <th>+7</th>
                                    <th>+8</th>
                                    <th>+9</th>
                                    <th>+A</th>
                                    <th>+B</th>
                                    <th>+C</th>
                                    <th>+D</th>
                                    <th>+E</th>
                                    <th>+F</th>
                                    <th>ASCII</th>
                                </tr>
                            </thead>
                            <tbody id="memory-table-body">
                                <tr>
                                    <td colspan="18" style="text-align: center; color: #858585; padding: 40px;">
                                        Connect to ST-Link and click "Read" to view memory
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- FLASH DOWNLOAD VIEW -->
            <div class="view flash-view" id="flash-view">
                <div class="card">
                    <div class="card-title">
                        <span class="card-title-icon">‚ö°</span>
                        Flash Download
                    </div>

                    <div class="file-drop-zone" id="drop-zone" onclick="selectFile()">
                        <div class="drop-icon">üìÅ</div>
                        <div class="drop-text">Drag and drop firmware file here</div>
                        <div class="drop-hint">Supported: .hex, .bin, .elf</div>
                    </div>
                    <input type="file" id="file-input" accept=".hex,.bin,.elf" style="display: none;">

                    <div class="file-info" id="file-info">
                        <div class="file-info-row">
                            <span class="file-info-label">File Name:</span>
                            <span class="file-info-value" id="file-name">-</span>
                        </div>
                        <div class="file-info-row">
                            <span class="file-info-label">File Size:</span>
                            <span class="file-info-value" id="file-size">-</span>
                        </div>
                        <div class="file-info-row">
                            <span class="file-info-label">File Type:</span>
                            <span class="file-info-value" id="file-type">-</span>
                        </div>
                        <div class="file-info-row">
                            <span class="file-info-label">Start Address:</span>
                            <span class="file-info-value" id="file-address">0x08000000</span>
                        </div>
                    </div>

                    <div class="card-title" style="margin-top: 20px;">Download Options</div>
                    <div class="flash-options">
                        <div class="checkbox-group">
                            <input type="checkbox" id="verify-after" checked>
                            <label for="verify-after">Verify after programming</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="run-after" checked>
                            <label for="run-after">Run after programming</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="full-chip-erase">
                            <label for="full-chip-erase">Full chip erase</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="skip-erase">
                            <label for="skip-erase">Skip flash erase</label>
                        </div>
                    </div>

                    <div class="progress-bar" id="flash-progress">
                        <div class="progress-fill" id="flash-progress-fill" style="width: 0%"></div>
                    </div>

                    <div class="flash-actions">
                        <button class="btn btn-success" onclick="startDownload()" id="download-btn" disabled>
                            ‚ö° Start Programming
                        </button>
                        <button class="btn btn-danger" onclick="eraseChip()">
                            üóëÔ∏è Erase Chip
                        </button>
                        <button class="btn btn-secondary" onclick="readDeviceMemory()">
                            üìñ Read Device Memory
                        </button>
                    </div>
                </div>
            </div>

            <!-- OPTION BYTES VIEW -->
            <div class="view" id="options-view" style="padding: 20px;">
                <div class="card">
                    <div class="card-title">
                        <span class="card-title-icon">‚öôÔ∏è</span>
                        Option Bytes Configuration
                    </div>
                    <div style="padding: 40px; text-align: center; color: #858585;">
                        <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                        <div style="font-size: 14px; margin-bottom: 10px;">Option Bytes Configuration</div>
                        <div style="font-size: 12px;">
                            Connect to a device to configure option bytes<br>
                            (Read Protection, Write Protection, Boot Configuration)
                        </div>
                    </div>
                </div>
            </div>

            <!-- DEBUG VIEW -->
            <div class="view" id="debug-view" style="padding: 20px; overflow-y: auto;">
                <!-- DEBUG CONTROLS -->
                <div class="card">
                    <div class="card-title">
                        <span class="card-title-icon">üêõ</span>
                        Debug Controls
                    </div>
                    <div class="debug-controls" style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="debugRun()" title="Run (F5)">
                            ‚ñ∂Ô∏è Run
                        </button>
                        <button class="btn btn-danger" onclick="debugStop()" title="Stop (Shift+F5)">
                            ‚èπÔ∏è Stop
                        </button>
                        <button class="btn btn-warning" onclick="debugPause()" title="Pause">
                            ‚è∏Ô∏è Pause
                        </button>
                        <button class="btn btn-primary" onclick="debugContinue()" title="Continue">
                            ‚ñ∂Ô∏è Continue
                        </button>
                        <div style="width: 2px; background: #3e3e42; margin: 0 5px;"></div>
                        <button class="btn btn-info" onclick="debugStepOver()" title="Step Over (F10)">
                            ‚è≠Ô∏è Step Over
                        </button>
                        <button class="btn btn-info" onclick="debugStepInto()" title="Step Into (F11)">
                            ‚§µÔ∏è Step Into
                        </button>
                        <button class="btn btn-info" onclick="debugStepOut()" title="Step Out (Shift+F11)">
                            ‚§¥Ô∏è Step Out
                        </button>
                        <div style="width: 2px; background: #3e3e42; margin: 0 5px;"></div>
                        <button class="btn btn-secondary" onclick="debugReset()" title="Reset MCU">
                            üîÑ Reset
                        </button>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #1e1e1e; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 12px;"
                        id="debug-status">
                        <span style="color: #858585;">Debug Status: Not Running</span>
                    </div>
                </div>

                <!-- VARIABLE VIEWER -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-title">
                        <span class="card-title-icon">üìä</span>
                        Variable Viewer
                        <button class="btn btn-sm" onclick="addVariable()" style="margin-left: auto; font-size: 12px;">+
                            Add Variable</button>
                    </div>
                    <div class="variable-table-container">
                        <table class="debug-table">
                            <thead>
                                <tr>
                                    <th style="width: 30px;">üìå</th>
                                    <th>Variable Name</th>
                                    <th>Type</th>
                                    <th>Value</th>
                                    <th>Address</th>
                                    <th style="width: 80px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="variable-list">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: #858585; padding: 20px;">
                                        No variables added. Click "+ Add Variable" to monitor a variable.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- REGISTER VIEWER -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-title">
                        <span class="card-title-icon">üéöÔ∏è</span>
                        Register Viewer
                        <button class="btn btn-sm" onclick="refreshRegisters()"
                            style="margin-left: auto; font-size: 12px;">üîÑ Refresh</button>
                    </div>
                    <div class="register-grid"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
                        <div class="register-item" id="reg-r0">
                            <div class="register-name">R0</div>
                            <div class="register-value">0x00000000</div>
                        </div>
                        <div class="register-item" id="reg-r1">
                            <div class="register-name">R1</div>
                            <div class="register-value">0x00000000</div>
                        </div>
                        <div class="register-item" id="reg-r2">
                            <div class="register-name">R2</div>
                            <div class="register-value">0x00000000</div>
                        </div>
                        <div class="register-item" id="reg-r3">
                            <div class="register-name">R3</div>
                            <div class="register-value">0x00000000</div>
                        </div>
                        <div class="register-item" id="reg-r4">
                            <div class="register-name">R4</div>
                            <div class="register-value">0x00000000</div>
                        </div>
                        <div class="register-item" id="reg-r5">
                            <div class="register-name">R5</div>
                            <div class="register-value">0x00000000</div>
                        </div>
                        <div class="register-item" id="reg-r6">
                            <div class="register-name">R6</div>
                            <div class="register-value">0x00000000</div>
                        </div>
                        <div class="register-item" id="reg-r7">
                            <div class="register-name">R7</div>
                            <div class="register-value">0x00000000</div>
                        </div>
                        <div class="register-item" id="reg-r8">
                            <div class="register-name">R8</div>
                            <div class="register-value">0x00000000</div>
                        </div>
                        <div class="register-item" id="reg-r9">
                            <div class="register-name">R9</div>
                            <div class="register-value">0x00000000</div>
                        </div>
                        <div class="register-item" id="reg-r10">
                            <div class="register-name">R10</div>
                            <div class="register-value">0x00000000</div>
                        </div>
                        <div class="register-item" id="reg-r11">
                            <div class="register-name">R11</div>
                            <div class="register-value">0x00000000</div>
                        </div>
                        <div class="register-item" id="reg-r12">
                            <div class="register-name">R12</div>
                            <div class="register-value">0x00000000</div>
                        </div>
                        <div class="register-item highlight" id="reg-sp">
                            <div class="register-name">SP</div>
                            <div class="register-value">0x20020000</div>
                        </div>
                        <div class="register-item highlight" id="reg-lr">
                            <div class="register-name">LR</div>
                            <div class="register-value">0x00000000</div>
                        </div>
                        <div class="register-item highlight" id="reg-pc">
                            <div class="register-name">PC</div>
                            <div class="register-value">0x08000000</div>
                        </div>
                    </div>
                </div>

                <!-- BREAKPOINTS -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-title">
                        <span class="card-title-icon">üî¥</span>
                        Breakpoints
                        <button class="btn btn-sm" onclick="addBreakpoint()"
                            style="margin-left: auto; font-size: 12px;">+ Add Breakpoint</button>
                    </div>
                    <div class="breakpoint-list" id="breakpoint-list">
                        <div style="text-align: center; color: #858585; padding: 20px;">
                            No breakpoints set. Click "+ Add Breakpoint" to add one.
                        </div>
                    </div>
                </div>

                <!-- CALL STACK -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-title">
                        <span class="card-title-icon">üìö</span>
                        Call Stack
                    </div>
                    <div class="callstack-list" id="callstack-list">
                        <div style="text-align: center; color: #858585; padding: 20px;">
                            Start debugging to view call stack
                        </div>
                    </div>
                </div>

                <!-- DISASSEMBLY VIEW -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-title">
                        <span class="card-title-icon">üîç</span>
                        Disassembly View
                        <button class="btn btn-sm" onclick="refreshDisassembly()"
                            style="margin-left: auto; font-size: 12px;">üîÑ Refresh</button>
                    </div>
                    <div class="disassembly-view" id="disassembly-view"
                        style="font-family: 'Courier New', monospace; font-size: 12px; background: #1e1e1e; border-radius: 4px; padding: 10px; max-height: 400px; overflow-y: auto;">
                        <div style="text-align: center; color: #858585; padding: 20px;">
                            Start debugging to view disassembly
                        </div>
                    </div>
                </div>

                <!-- SWV TRACE VIEWER -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-title">
                        <span class="card-title-icon">üì°</span>
                        SWV Trace Viewer (Serial Wire Viewer)
                        <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 11px; color: #858585;">CPU Freq (MHz):</label>
                            <input type="number" id="swv-cpu-freq" value="168"
                                style="width: 70px; padding: 4px 8px; background: #1e1e1e; border: 1px solid #3e3e42; color: #cccccc; border-radius: 4px; font-size: 12px;">
                            <button class="btn btn-sm btn-success" onclick="enableSWV()" id="swv-enable-btn">‚ñ∂Ô∏è
                                Enable</button>
                            <button class="btn btn-sm btn-danger" onclick="disableSWV()" id="swv-disable-btn"
                                style="display: none;">‚èπÔ∏è Disable</button>
                            <button class="btn btn-sm btn-secondary" onclick="clearSWVTrace()">üóëÔ∏è Clear</button>
                        </div>
                    </div>
                    <div
                        style="background: #1e1e1e; border-radius: 4px; padding: 10px; font-family: 'Courier New', monospace; font-size: 12px;">
                        <div style="margin-bottom: 10px; color: #858585; font-size: 11px;">
                            üí° Tip: Use ITM_SendChar() in your code for printf-style debugging without UART
                        </div>
                        <div id="swv-trace-output"
                            style="max-height: 300px; overflow-y: auto; background: #000000; padding: 10px; border-radius: 4px; border: 1px solid #3e3e42;">
                            <div style="color: #858585; text-align: center; padding: 10px;">
                                SWV Trace disabled. Click "Enable" to start capturing ITM trace data.
                            </div>
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                            <span style="color: #858585; font-size: 11px;">Status:</span>
                            <span id="swv-status" style="color: #858585; font-size: 11px;">Disabled</span>
                            <span style="margin-left: auto; color: #858585; font-size: 11px;">Packets:</span>
                            <span id="swv-packet-count" style="color: #4ec9b0; font-size: 11px;">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- OUTPUT CONSOLE -->
            <div class="output-console">
                <div class="console-header">
                    <div class="console-title">OUTPUT</div>
                    <div class="console-actions">
                        <button class="console-btn" onclick="clearConsole()" title="Clear">üóëÔ∏è</button>
                        <button class="console-btn" onclick="saveConsoleLog()" title="Save Log">üíæ</button>
                    </div>
                </div>
                <div class="console-content" id="console-output">


                </div>
            </div>

            <!-- Debug Panel - Saƒü Sidebar -->
            <div class="debug-panel" id="debug-panel">
                <!-- Debug Toolbar -->
                <div class="debug-toolbar">
                    <button class="debug-btn success" onclick="debugContinue()">‚ñ∂Ô∏è Continue</button>
                    <button class="debug-btn" onclick="debugPause()">‚è∏Ô∏è Pause</button>
                    <button class="debug-btn" onclick="debugStepOver()">‚è≠Ô∏è Step Over</button>
                    <button class="debug-btn" onclick="debugStepInto()">‚§µÔ∏è Step Into</button>
                    <button class="debug-btn" onclick="debugStepOut()">‚§¥Ô∏è Step Out</button>
                    <button class="debug-btn" onclick="debugReset()">üîÑ Reset</button>
                </div>

                <!-- Debug Status -->
                <div class="debug-status" id="debug-status">Status: Stopped</div>

                <!-- Registers -->
                <div class="debug-section">
                    <div class="debug-section-header" onclick="toggleSection('registers')">
                        <span>üéöÔ∏è Registers</span>
                        <span id="registers-toggle">‚ñº</span>
                    </div>
                    <div class="debug-section-content" id="registers-content">
                        <div class="register-grid" id="register-grid">
                            <div class="register-item"><span class="register-name">R0</span><span
                                    class="register-value">0x00000000</span></div>
                            <div class="register-item"><span class="register-name">R1</span><span
                                    class="register-value">0x00000000</span></div>
                            <div class="register-item"><span class="register-name">R2</span><span
                                    class="register-value">0x00000000</span></div>
                            <div class="register-item"><span class="register-name">R3</span><span
                                    class="register-value">0x00000000</span></div>
                            <div class="register-item"><span class="register-name">R4</span><span
                                    class="register-value">0x00000000</span></div>
                            <div class="register-item"><span class="register-name">R5</span><span
                                    class="register-value">0x00000000</span></div>
                            <div class="register-item"><span class="register-name">R6</span><span
                                    class="register-value">0x00000000</span></div>
                            <div class="register-item"><span class="register-name">R7</span><span
                                    class="register-value">0x00000000</span></div>
                            <div class="register-item"><span class="register-name">R8</span><span
                                    class="register-value">0x00000000</span></div>
                            <div class="register-item"><span class="register-name">R9</span><span
                                    class="register-value">0x00000000</span></div>
                            <div class="register-item"><span class="register-name">R10</span><span
                                    class="register-value">0x00000000</span></div>
                            <div class="register-item"><span class="register-name">R11</span><span
                                    class="register-value">0x00000000</span></div>
                            <div class="register-item"><span class="register-name">R12</span><span
                                    class="register-value">0x00000000</span></div>
                            <div class="register-item"><span class="register-name">SP</span><span
                                    class="register-value">0x20020000</span></div>
                            <div class="register-item"><span class="register-name">LR</span><span
                                    class="register-value">0x00000000</span></div>
                            <div class="register-item"><span class="register-name">PC</span><span
                                    class="register-value">0x08000000</span></div>
                        </div>
                    </div>
                </div>

                <!-- Variables -->
                <div class="debug-section">
                    <div class="debug-section-header" onclick="toggleSection('variables')">
                        <span>üìä Variables</span>
                        <span id="variables-toggle">‚ñº</span>
                    </div>
                    <div class="debug-section-content" id="variables-content">
                        <div id="variables-list">
                            <div style="color: #888; font-size: 11px;">Start debugging to view variables</div>
                        </div>
                        <button class="debug-btn" onclick="addVariable()" style="margin-top: 8px; width: 100%;">+ Add
                            Variable</button>
                    </div>
                </div>

                <!-- Breakpoints -->
                <div class="debug-section">
                    <div class="debug-section-header" onclick="toggleSection('breakpoints')">
                        <span>üî¥ Breakpoints</span>
                        <span id="breakpoints-toggle">‚ñº</span>
                    </div>
                    <div class="debug-section-content" id="breakpoints-content">
                        <div id="breakpoints-list">
                            <div style="color: #888; font-size: 11px;">No breakpoints set</div>
                        </div>
                        <button class="debug-btn" onclick="addBreakpoint()" style="margin-top: 8px; width: 100%;">+ Add
                            Breakpoint</button>
                    </div>
                </div>

                <!-- Call Stack -->
                <div class="debug-section">
                    <div class="debug-section-header" onclick="toggleSection('callstack')">
                        <span>üìö Call Stack</span>
                        <span id="callstack-toggle">‚ñº</span>
                    </div>
                    <div class="debug-section-content" id="callstack-content">
                        <div id="callstack-list">
                            <div style="color: #888; font-size: 11px;">Start debugging to view call stack</div>
                        </div>
                    </div>
                </div>

                <!-- Memory View -->
                <div class="debug-section">
                    <div class="debug-section-header" onclick="toggleSection('memory')">
                        <span>üß† Memory</span>
                        <span id="memory-toggle">‚ñº</span>
                    </div>
                    <div class="debug-section-content" id="memory-content">
                        <div style="display: flex; gap: 4px; margin-bottom: 8px;">
                            <input type="text" id="memory-address" placeholder="0x20000000"
                                style="flex: 1; background: #1e1e1e; border: 1px solid #3e3e42; color: #d4d4d4; padding: 4px; font-size: 11px;">
                            <button class="debug-btn" onclick="readMemory()">Read</button>
                        </div>
                        <div id="memory-view"
                            style="font-family: 'Consolas', monospace; font-size: 10px; color: #ce9178;">
                            --
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DEVICE INFO PANEL -->
        <div class="device-info-panel">
            <div class="info-section">
                <div class="info-section-title">Connection Status</div>
                <div class="info-row">
                    <span class="info-label">Status:</span>
                    <span class="info-value">
                        <span class="connection-indicator disconnected" id="connection-indicator"></span>
                        <span id="connection-status">Disconnected</span>
                    </span>
                </div>
            </div>

            <div class="info-section" id="stlink-info-section" style="display: none;">
                <div class="info-section-title">ST-Link Information</div>
                <div class="info-row">
                    <span class="info-label">Version:</span>
                    <span class="info-value" id="stlink-version">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Firmware:</span>
                    <span class="info-value" id="stlink-firmware">-</span>
                </div>
            </div>

            <div class="info-section" id="mcu-info-section" style="display: none;">
                <div class="info-section-title">MCU Information</div>
                <div class="info-row">
                    <span class="info-label">MCU Type:</span>
                    <span class="info-value" id="mcu-type" style="color: #4ec9b0; font-weight: 600;">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Device:</span>
                    <span class="info-value" id="mcu-device">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Device ID:</span>
                    <span class="info-value" id="mcu-id">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Flash Size:</span>
                    <span class="info-value" id="mcu-flash">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">RAM Size:</span>
                    <span class="info-value" id="mcu-ram">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Core:</span>
                    <span class="info-value" id="mcu-core">-</span>
                </div>
            </div>

            <div class="info-section">
                <div class="info-section-title">Quick Actions</div>
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="showView('stlink')">
                    üîå Connection Settings
                </button>
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="showView('flash')">
                    ‚ö° Flash Firmware
                </button>
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="showView('memory')">
                    üíæ Memory Browser
                </button>
            </div>
        </div>
    </div>

    <!-- STATUS BAR -->
    <div class="status-bar">
        <div class="status-item">
            <span class="status-icon">üìÅ</span>
            <span id="status-project">No project</span>
        </div>
        <div class="status-item">
            <span class="status-icon">üîå</span>
            <span id="status-device">No device</span>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');

        let currentProject = null;
        let currentDevice = null;
        let selectedFile = null;

        // View management
        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));

            // Show selected view
            document.getElementById(viewName + '-view').classList.add('active');

            // Update sidebar icons
            document.querySelectorAll('.sidebar-icon').forEach(icon => {
                icon.classList.remove('active');
            });

            const views = ['editor', 'stlink', 'memory', 'flash', 'options'];
            const index = views.indexOf(viewName);
            if (index >= 0) {
                document.querySelectorAll('.sidebar-icon')[index].classList.add('active');
            }
        }

        // IPC Listeners
        ipcRenderer.on('new-file', () => {
            if (editor) {
                editor.setValue('');
                currentFile = null;
                updateUI();
            }
        });

        ipcRenderer.on('open-file', (event, data) => {
            if (editor) {
                editor.setValue(data.content);
                currentFile = data;
                updateUI();
                document.getElementById('welcome').style.display = 'none';
                document.getElementById('editor').style.display = 'block';
            }
        });

        ipcRenderer.on('open-project', (event, data) => {
            document.getElementById('project-info').textContent = data.path;
            outputAppend(`üìÅ Opened project: ${data.path}\n`);

            // Load and display file tree
            loadFileTree(data.path);
        });

        // Load file tree for project
        function loadFileTree(projectPath) {
            const fs = require('fs');
            const path = require('path');
            const fileTreeEl = document.getElementById('file-tree');

            try {
                const files = fs.readdirSync(projectPath);
                let html = '<div style="font-size: 12px;">';

                // Sort: directories first, then files
                const sorted = files.sort((a, b) => {
                    const aPath = path.join(projectPath, a);
                    const bPath = path.join(projectPath, b);
                    const aIsDir = fs.statSync(aPath).isDirectory();
                    const bIsDir = fs.statSync(bPath).isDirectory();

                    if (aIsDir && !bIsDir) return -1;
                    if (!aIsDir && bIsDir) return 1;
                    return a.localeCompare(b);
                });

                sorted.forEach(file => {
                    // Skip hidden files and build directories
                    if (file.startsWith('.') || file === 'build' || file === 'node_modules') return;

                    const fullPath = path.join(projectPath, file);
                    const stats = fs.statSync(fullPath);

                    if (stats.isDirectory()) {
                        html += `<div style="padding: 4px; cursor: pointer; color: #569cd6;" onclick="toggleFolder('${fullPath}')">üìÅ ${file}</div>`;
                    } else {
                        const ext = path.extname(file);
                        let icon = 'üìÑ';
                        if (['.c', '.h', '.cpp', '.hpp'].includes(ext)) icon = 'üìù';
                        else if (ext === '.s' || ext === '.asm') icon = '‚öôÔ∏è';
                        else if (ext === '.ld') icon = 'üîó';

                        html += `<div style="padding: 4px; padding-left: 10px; cursor: pointer; color: #dcdcdc;" onclick="openFileFromTree('${fullPath}')">${icon} ${file}</div>`;
                    }
                });

                html += '</div>';

                // Add auto-detection info
                html += `<div style="margin-top: 15px; padding: 8px; background: #1e1e1e; border-radius: 4px; font-size: 11px;">
                    <div style="color: #4ec9b0; font-weight: bold; margin-bottom: 5px;">üîç Auto-Detection</div>
                    <div style="color: #9cdcfe;">STM32 chip will be automatically detected during flash/debug</div>
                    <div style="color: #6a9955; margin-top: 5px;">‚úì No configuration needed!</div>
                </div>`;

                fileTreeEl.innerHTML = html;
            } catch (err) {
                fileTreeEl.innerHTML = `<div style="color: #f48771;">Error loading files: ${err.message}</div>`;
            }
        }

        function openFileFromTree(filePath) {
            ipcRenderer.send('open-file-path', filePath);
        }

        function toggleFolder(folderPath) {
            outputAppend(`üìÅ ${folderPath}\n`);
        }

        ipcRenderer.on('get-editor-content', (event, action) => {
            if (editor) {
                const content = editor.getValue();
                if (action === 'save') {
                    ipcRenderer.send('save-file-content', content);
                } else if (action === 'save-as') {
                    ipcRenderer.send('save-file-as-content', content);
                }
            }
        });

        ipcRenderer.on('file-saved', (event, path) => {
            outputAppend(`üíæ Saved: ${path}\n`);
        });

        ipcRenderer.on('output-clear', () => {
            document.getElementById('output').textContent = '';
        });

        ipcRenderer.on('output-append', (event, text) => {
            outputAppend(text);
        });

        // UI Functions
        function openFile() {
            ipcRenderer.send('open-file-dialog');
        }

        function clearConsole() {
            document.getElementById('console-output').innerHTML = '';
            appendConsole('Console cleared.', 'normal');
        }

        function saveConsoleLog() {
            const content = document.getElementById('console-output').innerText;
            ipcRenderer.send('save-console-log', content);
            appendConsole('Log saved.', 'success');
        }

        // Project functions
        function openProject() {
            ipcRenderer.send('open-project');
        }

        function buildProject() {
            if (!currentProject) {
                appendConsole('Error: No project opened', 'error');
                return;
            }
            appendConsole('Building project...', 'normal');
            ipcRenderer.send('build-project', false); // No auto-flash
        }

        function buildAndFlash() {
            if (!currentProject) {
                appendConsole('Error: No project opened', 'error');
                return;
            }
            if (!currentDevice) {
                appendConsole('Warning: No device connected. Will build only.', 'warning');
            }
            appendConsole('Building and flashing...', 'normal');
            ipcRenderer.send('build-project', true); // With auto-flash
        }

        function flashDevice() {
            outputAppend('‚ö° Flashing...\n');
            ipcRenderer.send('flash-device');
        }

        // ST-Link functions
        function refreshDevices() {
            appendConsole('Scanning for ST-Link devices...', 'normal');
            ipcRenderer.send('scan-stlinks');
        }

        // Debug Functions
        let debugActive = false;

        function startDebug() {
            outputAppend('\n‚ñ∂Ô∏è Starting debug session...\n');
            debugActive = true;
            updateDebugStatus('Running');
            showDebugPanel();
            ipcRenderer.send('debug-start');
        }

        function stopDebug() {
            outputAppend('‚èπÔ∏è Stopping debug session...\n');
            debugActive = false;
            updateDebugStatus('Stopped');
            ipcRenderer.send('debug-stop');
        }

        function debugContinue() {
            if (!debugActive) return;
            outputAppend('‚ñ∂Ô∏è Continue...\n');
            ipcRenderer.send('debug-continue');
        }

        function debugPause() {
            if (!debugActive) return;
            outputAppend('‚è∏Ô∏è Pause...\n');
            ipcRenderer.send('debug-pause');
        }

        function debugStepOver() {
            if (!debugActive) return;
            outputAppend('‚è≠Ô∏è Step Over...\n');
            ipcRenderer.send('debug-step-over');
        }

        function debugStepInto() {
            if (!debugActive) return;
            outputAppend('‚§µÔ∏è Step Into...\n');
            ipcRenderer.send('debug-step-into');
        }

        function debugStepOut() {
            if (!debugActive) return;
            outputAppend('‚§¥Ô∏è Step Out...\n');
            ipcRenderer.send('debug-step-out');
        }

        function debugReset() {
            outputAppend('üîÑ Reset...\n');
            ipcRenderer.send('debug-reset');
        }

        function toggleDebugPanel() {
            const panel = document.getElementById('debug-panel');
            panel.classList.toggle('visible');
        }

        function showDebugPanel() {
            const panel = document.getElementById('debug-panel');
            panel.classList.add('visible');
        }

        function toggleSection(section) {
            const content = document.getElementById(section + '-content');
            const toggle = document.getElementById(section + '-toggle');
            content.classList.toggle('collapsed');
            toggle.textContent = content.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
        }

        function updateDebugStatus(status) {
            const statusEl = document.getElementById('debug-status');
            statusEl.textContent = 'Status: ' + status;
            statusEl.className = 'debug-status ' + status.toLowerCase();
        }

        function updateRegisters(registers) {
            const grid = document.getElementById('register-grid');
            const items = grid.querySelectorAll('.register-item');
            const regNames = ['R0', 'R1', 'R2', 'R3', 'R4', 'R5', 'R6', 'R7', 'R8', 'R9', 'R10', 'R11', 'R12', 'SP', 'LR', 'PC'];

            items.forEach((item, i) => {
                const name = regNames[i].toLowerCase();
                if (registers[name]) {
                    item.querySelector('.register-value').textContent = registers[name];
                }
            });
        }

        function addVariable() {
            const name = prompt('Variable name:');
            if (name) {
                ipcRenderer.send('debug-add-variable', name);
            }
        }

        function addBreakpoint() {
            const location = prompt('Breakpoint location (file:line):');
            if (location) {
                ipcRenderer.send('debug-add-breakpoint', location);
            }
        }

        function readMemory() {
            const address = document.getElementById('memory-address').value || '0x20000000';
            ipcRenderer.send('debug-read-memory', address);
        }

        // IPC Listeners for Debug
        ipcRenderer.on('debug-registers', (event, registers) => {
            updateRegisters(registers);
        });

        ipcRenderer.on('debug-status-update', (event, status) => {
            updateDebugStatus(status);
        });

        ipcRenderer.on('debug-memory', (event, data) => {
            const view = document.getElementById('memory-view');
            view.textContent = data;
        });

        ipcRenderer.on('debug-variables', (event, variables) => {
            const list = document.getElementById('variables-list');
            if (variables.length === 0) {
                list.innerHTML = '<div style="color: #888; font-size: 11px;">No variables</div>';
            } else {
                list.innerHTML = variables.map(v =>
                    `<div class="variable-item"><span>${v.name}</span>: <span style="color: #ce9178;">${v.value}</span></div>`
                ).join('');
            }
        });

        ipcRenderer.on('debug-breakpoints', (event, breakpoints) => {
            const list = document.getElementById('breakpoints-list');
            if (breakpoints.length === 0) {
                list.innerHTML = '<div style="color: #888; font-size: 11px;">No breakpoints</div>';
            } else {
                list.innerHTML = breakpoints.map(bp =>
                    `<div class="breakpoint-item">üî¥ ${bp.file}:${bp.line}</div>`
                ).join('');
            }
        });

        function outputAppend(text) {
            const output = document.getElementById('output');
            output.textContent += text;
            output.scrollTop = output.scrollHeight;
        }

        function disconnectDevice(deviceId) {
            appendConsole('Disconnecting device...', 'normal');
            ipcRenderer.send('disconnect-stlink', deviceId);
        }

        // Memory functions
        function readMemory() {
            if (!currentDevice) {
                appendConsole('Error: No device connected', 'error');
                return;
            }

            const address = document.getElementById('memory-address').value;
            const size = parseInt(document.getElementById('memory-size').value);

            appendConsole(`Reading ${size} bytes from ${address}...`, 'normal');
            ipcRenderer.send('read-memory', { address, size });
        }

        function saveMemory() {
            appendConsole('Saving memory dump...', 'normal');
            // TODO: Implement save memory
        }

        // Flash functions
        function selectFile() {
            document.getElementById('file-input').click();
        }

        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                document.getElementById('file-info').classList.add('active');
                document.getElementById('file-name').textContent = file.name;
                document.getElementById('file-size').textContent = (file.size / 1024).toFixed(2) + ' KB';
                document.getElementById('file-type').textContent = file.name.split('.').pop().toUpperCase();
                document.getElementById('download-btn').disabled = false;
                appendConsole(`File selected: ${file.name}`, 'success');
            }
        });

        function startDownload() {
            if (!currentDevice) {
                appendConsole('Error: No device connected', 'error');
                return;
            }

            if (!selectedFile) {
                appendConsole('Error: No file selected', 'error');
                return;
            }

            const options = {
                verify: document.getElementById('verify-after').checked,
                run: document.getElementById('run-after').checked,
                fullErase: document.getElementById('full-chip-erase').checked,
                skipErase: document.getElementById('skip-erase').checked
            };

            appendConsole('Starting flash programming...', 'normal');
            document.getElementById('flash-progress').classList.add('active');

            ipcRenderer.send('flash-firmware', { file: selectedFile.path, options });
        }

        function eraseChip() {
            if (!currentDevice) {
                appendConsole('Error: No device connected', 'error');
                return;
            }

            if (confirm('Are you sure you want to erase the entire chip?')) {
                appendConsole('Erasing chip...', 'warning');
                ipcRenderer.send('erase-chip');
            }
        }

        function readDeviceMemory() {
            if (!currentDevice) {
                appendConsole('Error: No device connected', 'error');
                return;
            }

            appendConsole('Reading device memory...', 'normal');
            ipcRenderer.send('read-device-memory');
        }

        // Drag and drop
        const dropZone = document.getElementById('drop-zone');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');

            const file = e.dataTransfer.files[0];
            if (file) {
                selectedFile = file;
                document.getElementById('file-info').classList.add('active');
                document.getElementById('file-name').textContent = file.name;
                document.getElementById('file-size').textContent = (file.size / 1024).toFixed(2) + ' KB';
                document.getElementById('file-type').textContent = file.name.split('.').pop().toUpperCase();
                document.getElementById('download-btn').disabled = false;
                appendConsole(`File selected: ${file.name}`, 'success');
            }
        });

        // IPC event listeners
        ipcRenderer.on('project-opened', (event, project) => {
            currentProject = project;
            document.getElementById('status-project').textContent = project.name;
            appendConsole(`Project opened: ${project.name}`, 'success');

            // Update file tree
            const tree = document.getElementById('file-tree');
            tree.innerHTML = '';
            if (project.folders) {
                renderFolderTree(project.folders, tree, 0);
            }
        });

        ipcRenderer.on('stlink-devices', (event, devices) => {
            const list = document.getElementById('device-list');
            list.innerHTML = '';

            if (devices.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: #858585;">No ST-Link devices found</div>';
                return;
            }

            devices.forEach(device => {
                const card = document.createElement('div');
                card.className = 'device-card' + (device.connected ? ' connected' : '');

                card.innerHTML = `
                    <div class="device-info">
                        <div class="device-name">${device.name}</div>
                        <div class="device-details">Serial: ${device.serial || 'Unknown'}</div>
                        ${device.mcu ? `<div class="device-details">MCU: ${device.mcu}</div>` : ''}
                        ${device.connected ? '<div class="device-status">‚úì Connected</div>' : ''}
                    </div>
                    <button class="btn ${device.connected ? 'btn-danger' : 'btn-success'}"
                            onclick="${device.connected ? 'disconnectDevice' : 'connectDevice'}('${device.id}')">
                        ${device.connected ? 'üîå Disconnect' : 'üîå Connect'}
                    </button>
                `;

                list.appendChild(card);
            });

            appendConsole(`Found ${devices.length} ST-Link device(s)`, 'success');
        });

        ipcRenderer.on('device-connected', (event, deviceInfo) => {
            currentDevice = deviceInfo;
            document.getElementById('status-device').textContent = deviceInfo.name;
            document.getElementById('connection-status').textContent = 'Connected';
            document.getElementById('connection-indicator').classList.remove('disconnected');
            document.getElementById('connection-indicator').classList.add('connected');

            // Show info panels
            document.getElementById('stlink-info-section').style.display = 'block';
            document.getElementById('mcu-info-section').style.display = 'block';

            // Update info
            if (deviceInfo.stlink) {
                document.getElementById('stlink-version').textContent = deviceInfo.stlink.version;
                document.getElementById('stlink-firmware').textContent = deviceInfo.stlink.firmware;
            }

            if (deviceInfo.mcu) {
                document.getElementById('mcu-type').textContent = deviceInfo.mcu.type || 'STM32';
                document.getElementById('mcu-device').textContent = deviceInfo.mcu.device;
                document.getElementById('mcu-id').textContent = deviceInfo.mcu.id;
                document.getElementById('mcu-flash').textContent = deviceInfo.mcu.flash;
                document.getElementById('mcu-ram').textContent = deviceInfo.mcu.ram;
                document.getElementById('mcu-core').textContent = deviceInfo.mcu.core;
            }

            appendConsole('Device connected successfully', 'success');
        });

        ipcRenderer.on('device-disconnected', () => {
            currentDevice = null;
            document.getElementById('status-device').textContent = 'No device';
            document.getElementById('connection-status').textContent = 'Disconnected';
            document.getElementById('connection-indicator').classList.remove('connected');
            document.getElementById('connection-indicator').classList.add('disconnected');

            document.getElementById('stlink-info-section').style.display = 'none';
            document.getElementById('mcu-info-section').style.display = 'none';

            appendConsole('Device disconnected', 'warning');
        });

        ipcRenderer.on('output-append', (event, text) => {
            const lines = text.split('\n');
            lines.forEach(line => {
                if (line.trim()) {
                    let type = 'normal';
                    if (line.includes('‚ùå') || line.includes('Error')) type = 'error';
                    else if (line.includes('‚úÖ') || line.includes('Success')) type = 'success';
                    else if (line.includes('‚ö†Ô∏è') || line.includes('Warning')) type = 'warning';
                    appendConsole(line, type);
                }
            });
        });

        ipcRenderer.on('flash-progress', (event, percent) => {
            document.getElementById('flash-progress-fill').style.width = percent + '%';
        });

        ipcRenderer.on('build-complete', (event, result) => {
            if (result.success) {
                appendConsole('Build successful!', 'success');
            } else {
                appendConsole('Build failed: ' + result.error, 'error');
            }
        });

        function renderFolderTree(node, container, level) {
            if (node.type === 'folder') {
                const folderDiv = document.createElement('div');
                const folderItem = document.createElement('div');
                folderItem.className = 'folder-item';
                folderItem.style.paddingLeft = (8 + level * 16) + 'px';
                folderItem.innerHTML = `<span>üìÇ</span><span>${node.name}</span>`;

                const childrenDiv = document.createElement('div');
                childrenDiv.style.display = 'block';

                folderItem.onclick = () => {
                    childrenDiv.style.display = childrenDiv.style.display === 'none' ? 'block' : 'none';
                };

                folderDiv.appendChild(folderItem);
                folderDiv.appendChild(childrenDiv);
                container.appendChild(folderDiv);

                if (node.children) {
                    node.children.forEach(child => renderFolderTree(child, childrenDiv, level + 1));
                }
            } else if (node.type === 'file') {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.style.paddingLeft = (8 + level * 16) + 'px';
                fileItem.innerHTML = `<span>üìÑ</span><span>${node.name}</span>`;
                fileItem.onclick = () => {
                    ipcRenderer.send('read-file', node.path);
                };
                container.appendChild(fileItem);
            }
        }

        ipcRenderer.on('file-content', (event, data) => {
            document.getElementById('code-editor').value = data.content;
            appendConsole(`Opened: ${data.path}`, 'normal');
        });

        // Initialize
        appendConsole('üåü HopeIDE initialized - Let\'s build something amazing!', 'success');
        appendConsole('Click "Open Project" to start or "ST-Link Manager" to connect devices', 'normal');

        // ============================================
        // DEBUG FUNCTIONS
        // ============================================

        let debugRunning = false;
        let monitoredVariables = [];
        let breakpoints = [];

        // Debug Control Functions
        function debugRun() {
            if (!currentDevice) {
                appendConsole('‚ùå No device connected. Please connect ST-Link first.', 'error');
                return;
            }
            appendConsole('‚ñ∂Ô∏è Starting debug session...', 'normal');
            ipcRenderer.send('debug-start');
            debugRunning = true;
            updateDebugStatus('Running');
        }

        function debugStop() {
            appendConsole('‚èπÔ∏è Stopping debug session...', 'normal');
            ipcRenderer.send('debug-stop');
            debugRunning = false;
            updateDebugStatus('Not Running');
        }

        function debugPause() {
            if (!debugRunning) {
                appendConsole('‚ö†Ô∏è Debug session not running', 'warning');
                return;
            }
            appendConsole('‚è∏Ô∏è Pausing execution...', 'normal');
            ipcRenderer.send('debug-pause');
            updateDebugStatus('Paused');
        }

        function debugContinue() {
            if (!debugRunning) {
                appendConsole('‚ö†Ô∏è Debug session not running', 'warning');
                return;
            }
            appendConsole('‚ñ∂Ô∏è Continuing execution...', 'normal');
            ipcRenderer.send('debug-continue');
            updateDebugStatus('Running');
        }

        function debugStepOver() {
            if (!debugRunning) {
                appendConsole('‚ö†Ô∏è Debug session not running', 'warning');
                return;
            }
            appendConsole('‚è≠Ô∏è Step Over...', 'normal');
            ipcRenderer.send('debug-step-over');
        }

        function debugStepInto() {
            if (!debugRunning) {
                appendConsole('‚ö†Ô∏è Debug session not running', 'warning');
                return;
            }
            appendConsole('‚§µÔ∏è Step Into...', 'normal');
            ipcRenderer.send('debug-step-into');
        }

        function debugStepOut() {
            if (!debugRunning) {
                appendConsole('‚ö†Ô∏è Debug session not running', 'warning');
                return;
            }
            appendConsole('‚§¥Ô∏è Step Out...', 'normal');
            ipcRenderer.send('debug-step-out');
        }

        function debugReset() {
            appendConsole('üîÑ Resetting MCU...', 'normal');
            // TODO: Implement reset via OpenOCD
        }

        function updateDebugStatus(status) {
            const statusEl = document.getElementById('debug-status');
            let color = '#858585';
            if (status === 'Running') color = '#4ec9b0';
            else if (status === 'Paused') color = '#b89500';
            statusEl.innerHTML = `<span style="color: ${color};">Debug Status: ${status}</span>`;
        }

        // Variable Viewer Functions
        function addVariable() {
            const varName = prompt('Enter variable name to monitor:');
            if (!varName) return;

            monitoredVariables.push({
                name: varName,
                type: 'uint32_t',
                value: '0x00000000',
                address: '0x20000000'
            });

            updateVariableList();
            appendConsole(`üìä Added variable: ${varName}`, 'normal');
        }

        function removeVariable(index) {
            const varName = monitoredVariables[index].name;
            monitoredVariables.splice(index, 1);
            updateVariableList();
            appendConsole(`üóëÔ∏è Removed variable: ${varName}`, 'normal');
        }

        function updateVariableList() {
            const tbody = document.getElementById('variable-list');

            if (monitoredVariables.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #858585; padding: 20px;">
                            No variables added. Click "+ Add Variable" to monitor a variable.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = monitoredVariables.map((v, i) => `
                <tr>
                    <td>üìå</td>
                    <td>${v.name}</td>
                    <td>${v.type}</td>
                    <td style="font-family: 'Courier New', monospace; color: #4ec9b0;">${v.value}</td>
                    <td style="font-family: 'Courier New', monospace; color: #858585;">${v.address}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removeVariable(${i})" style="padding: 2px 8px;">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        // Register Viewer Functions
        function refreshRegisters() {
            if (!debugRunning) {
                appendConsole('‚ö†Ô∏è Debug session not running', 'warning');
                return;
            }
            appendConsole('üîÑ Refreshing registers...', 'normal');
            ipcRenderer.send('registers-read');
        }

        function updateRegisters(registers) {
            // Update register display
            for (const [reg, value] of Object.entries(registers)) {
                const regEl = document.getElementById(`reg-${reg.toLowerCase()}`);
                if (regEl) {
                    const valueEl = regEl.querySelector('.register-value');
                    if (valueEl) {
                        valueEl.textContent = '0x' + value.toString(16).toUpperCase().padStart(8, '0');
                    }
                }
            }
        }

        // Breakpoint Functions
        function addBreakpoint() {
            const location = prompt('Enter breakpoint location (file:line or address):');
            if (!location) return;

            breakpoints.push({
                location: location,
                enabled: true,
                hitCount: 0
            });

            updateBreakpointList();
            appendConsole(`üî¥ Breakpoint added: ${location}`, 'normal');

            // Send to backend
            if (location.includes(':')) {
                const [file, line] = location.split(':');
                ipcRenderer.send('breakpoint-toggle', { file, line: parseInt(line) });
            }
        }

        function removeBreakpoint(index) {
            const bp = breakpoints[index];
            breakpoints.splice(index, 1);
            updateBreakpointList();
            appendConsole(`üóëÔ∏è Removed breakpoint: ${bp.location}`, 'normal');
        }

        function toggleBreakpoint(index) {
            breakpoints[index].enabled = !breakpoints[index].enabled;
            updateBreakpointList();
        }

        function updateBreakpointList() {
            const container = document.getElementById('breakpoint-list');

            if (breakpoints.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #858585; padding: 20px;">
                        No breakpoints set. Click "+ Add Breakpoint" to add one.
                    </div>
                `;
                return;
            }

            container.innerHTML = breakpoints.map((bp, i) => `
                <div class="breakpoint-item">
                    <div>
                        <input type="checkbox" ${bp.enabled ? 'checked' : ''} onchange="toggleBreakpoint(${i})">
                        <span style="margin-left: 8px; font-family: 'Courier New', monospace;">${bp.location}</span>
                        ${bp.hitCount > 0 ? `<span style="margin-left: 10px; color: #858585; font-size: 11px;">(hit ${bp.hitCount}x)</span>` : ''}
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeBreakpoint(${i})" style="padding: 2px 8px;">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        // Call Stack Functions
        function updateCallStack(stack) {
            const container = document.getElementById('callstack-list');

            if (!stack || stack.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #858585; padding: 20px;">
                        No call stack available
                    </div>
                `;
                return;
            }

            container.innerHTML = stack.map((frame, i) => `
                <div class="callstack-item" onclick="navigateToFrame(${i})">
                    <div class="callstack-function">#${i} ${frame.function || 'unknown'}</div>
                    <div class="callstack-location">${frame.file || 'unknown'}:${frame.line || '?'}</div>
                    <div style="color: #b5cea8; font-size: 11px; margin-top: 2px;">0x${frame.address.toString(16).padStart(8, '0')}</div>
                </div>
            `).join('');
        }

        function navigateToFrame(index) {
            appendConsole(`üìç Navigating to frame #${index}`, 'normal');
            // TODO: Implement frame navigation
        }

        // Disassembly Functions
        function refreshDisassembly() {
            if (!debugRunning) {
                appendConsole('‚ö†Ô∏è Debug session not running', 'warning');
                return;
            }
            appendConsole('üîÑ Refreshing disassembly...', 'normal');
            // TODO: Implement disassembly fetch via GDB
        }

        function updateDisassembly(instructions) {
            const container = document.getElementById('disassembly-view');

            if (!instructions || instructions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #858585; padding: 20px;">
                        No disassembly available
                    </div>
                `;
                return;
            }

            container.innerHTML = instructions.map(inst => `
                <div class="disassembly-line ${inst.current ? 'current' : ''}">
                    <span class="disassembly-addr">0x${inst.address.toString(16).padStart(8, '0')}</span>
                    <span class="disassembly-bytes">${inst.bytes || ''}</span>
                    <span class="disassembly-inst">${inst.instruction || ''}</span>
                </div>
            `).join('');
        }

        // Listen to debug events from main process
        ipcRenderer.on('debug-started', () => {
            debugRunning = true;
            updateDebugStatus('Running');
            appendConsole('‚úÖ Debug session started', 'success');
        });

        ipcRenderer.on('debug-stopped', () => {
            debugRunning = false;
            updateDebugStatus('Not Running');
            appendConsole('‚èπÔ∏è Debug session stopped', 'normal');
        });

        ipcRenderer.on('registers-updated', (event, registers) => {
            updateRegisters(registers);
        });

        // Keyboard shortcuts for debugging
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F5' && !e.shiftKey) {
                e.preventDefault();
                debugRun();
            } else if (e.key === 'F5' && e.shiftKey) {
                e.preventDefault();
                debugStop();
            } else if (e.key === 'F10') {
                e.preventDefault();
                debugStepOver();
            } else if (e.key === 'F11' && !e.shiftKey) {
                e.preventDefault();
                debugStepInto();
            } else if (e.key === 'F11' && e.shiftKey) {
                e.preventDefault();
                debugStepOut();
            }
        });

        // ============================================
        // SWV TRACE FUNCTIONS
        // ============================================

        let swvEnabled = false;
        let swvPacketCount = 0;
        let swvPollInterval = null;

        function enableSWV() {
            if (!currentDevice) {
                appendConsole('‚ùå No device connected. Connect ST-Link first.', 'error');
                return;
            }

            const cpuFreq = parseInt(document.getElementById('swv-cpu-freq').value) * 1000000;
            const swoFreq = 2000000; // 2 MHz SWO frequency

            appendConsole(`üì° Enabling SWV Trace (CPU: ${cpuFreq / 1000000} MHz, SWO: ${swoFreq / 1000000} MHz)...`, 'normal');

            // Send enable command to backend
            ipcRenderer.send('swv-enable', { cpuFreq, swoFreq });

            swvEnabled = true;
            swvPacketCount = 0;

            // Update UI
            document.getElementById('swv-enable-btn').style.display = 'none';
            document.getElementById('swv-disable-btn').style.display = 'block';
            document.getElementById('swv-status').textContent = 'Enabled';
            document.getElementById('swv-status').style.color = '#4ec9b0';
            document.getElementById('swv-trace-output').innerHTML = '';

            // Start polling for SWV data
            swvPollInterval = setInterval(() => {
                ipcRenderer.send('swv-read');
            }, 100); // Poll every 100ms

            appendConsole('‚úÖ SWV Trace enabled. Use ITM_SendChar() in your firmware.', 'success');
        }

        function disableSWV() {
            appendConsole('‚èπÔ∏è Disabling SWV Trace...', 'normal');

            // Send disable command to backend
            ipcRenderer.send('swv-disable');

            swvEnabled = false;

            // Stop polling
            if (swvPollInterval) {
                clearInterval(swvPollInterval);
                swvPollInterval = null;
            }

            // Update UI
            document.getElementById('swv-enable-btn').style.display = 'block';
            document.getElementById('swv-disable-btn').style.display = 'none';
            document.getElementById('swv-status').textContent = 'Disabled';
            document.getElementById('swv-status').style.color = '#858585';

            appendConsole('‚èπÔ∏è SWV Trace disabled', 'normal');
        }

        function clearSWVTrace() {
            document.getElementById('swv-trace-output').innerHTML = '';
            swvPacketCount = 0;
            document.getElementById('swv-packet-count').textContent = '0';
            appendConsole('üóëÔ∏è SWV trace cleared', 'normal');
        }

        function appendSWVTrace(data) {
            const output = document.getElementById('swv-trace-output');
            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false, fractionalSecondDigits: 3 });

            // Create trace line
            const line = document.createElement('div');
            line.style.color = '#4ec9b0';
            line.style.marginBottom = '2px';
            line.innerHTML = `<span style="color: #858585;">[${timestamp}]</span> ${escapeHtml(data)}`;

            output.appendChild(line);

            // Auto-scroll to bottom
            output.scrollTop = output.scrollHeight;

            // Update packet count
            swvPacketCount++;
            document.getElementById('swv-packet-count').textContent = swvPacketCount;

            // Limit to last 1000 lines for performance
            while (output.children.length > 1000) {
                output.removeChild(output.firstChild);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Listen for SWV data from main process
        ipcRenderer.on('swv-data', (event, data) => {
            appendSWVTrace(data);
        });

        ipcRenderer.on('swv-enabled', () => {
            appendConsole('‚úÖ SWV hardware configured', 'success');
        });

        ipcRenderer.on('swv-error', (event, error) => {
            appendConsole(`‚ùå SWV Error: ${error}`, 'error');
            disableSWV();
        });
    </script>
    <!-- Target Setup Modal -->
    <div id="target-setup-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Cortex-M Target Driver Setup</h2>
                <span class="close" onclick="closeTargetSettings()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab-link active" onclick="openTab(event, 'DebugInfo')">Debug Adapter</button>
                    <button class="tab-link" onclick="openTab(event, 'TargetSettings')">Target Settings</button>
                    <button class="tab-link" onclick="openTab(event, 'FlashDownload')">Flash Download</button>
                </div>

                <!-- Debug Info Tab -->
                <div id="DebugInfo" class="tab-content" style="display: block;">
                    <fieldset>
                        <legend>Debug Adapter</legend>
                        <div class="form-group">
                            <label>Unit:</label>
                            <select id="adapter-unit" disabled>
                                <option>ST-LINK/V2</option>
                                <option>ST-LINK/V3</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Serial No:</label>
                            <input type="text" id="adapter-serial" readonly value="Detecting...">
                        </div>
                        <div class="form-group">
                            <label>Firmware:</label>
                            <input type="text" id="adapter-fw" readonly value="Detecting...">
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend>SW Device</legend>
                        <div id="sw-device-list">
                            <table class="device-table">
                                <thead>
                                    <tr>
                                        <th>IDCODE</th>
                                        <th>Device Name</th>
                                    </tr>
                                </thead>
                                <tbody id="detected-devices">
                                    <tr>
                                        <td colspan="2">Scanning...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </fieldset>
                </div>

                <!-- Target Settings Tab -->
                <div id="TargetSettings" class="tab-content">
                    <fieldset>
                        <legend>Target Com</legend>
                        <div class="form-group">
                            <label>Port:</label>
                            <select id="target-port">
                                <option value="swd">SW</option>
                                <option value="jtag">JTAG</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Clock:</label>
                            <select id="target-clock">
                                <option value="4000">4 MHz</option>
                                <option value="2000" selected>2 MHz</option>
                                <option value="1000">1 MHz</option>
                                <option value="500">500 kHz</option>
                            </select>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend>Connect & Reset Options</legend>
                        <div class="form-group">
                            <label>Connect:</label>
                            <select id="connect-mode">
                                <option value="normal">Normal</option>
                                <option value="under-reset">Under Reset</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Reset:</label>
                            <select id="reset-mode">
                                <option value="sysresetreq">Autodetect</option>
                                <option value="vectreset">VectReset</option>
                                <option value="sysresetreq">SysResetReq</option>
                            </select>
                        </div>
                    </fieldset>
                </div>

                <!-- Flash Download Tab -->
                <div id="FlashDownload" class="tab-content">
                    <fieldset>
                        <legend>Download Options</legend>
                        <div class="checkbox-group">
                            <input type="checkbox" id="verify-code" checked>
                            <label for="verify-code">Verify Code Download</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="download-to-flash" checked>
                            <label for="download-to-flash">Download to Flash</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="reset-run" checked>
                            <label for="reset-run">Reset and Run</label>
                        </div>
                    </fieldset>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeTargetSettings()">Cancel</button>
                <button class="btn success" onclick="saveTargetSettings()">OK</button>
            </div>
        </div>
    </div>

    <style>
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #252526;
            margin: 10% auto;
            padding: 0;
            border: 1px solid #3e3e42;
            width: 600px;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
            color: #cccccc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .modal-header {
            padding: 10px 15px;
            background-color: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 16px;
            font-weight: normal;
        }

        .close {
            color: #aaaaaa;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #ffffff;
        }

        .modal-body {
            padding: 15px;
            min-height: 300px;
        }

        .modal-footer {
            padding: 10px 15px;
            background-color: #2d2d30;
            border-top: 1px solid #3e3e42;
            text-align: right;
        }

        /* Tabs */
        .tabs {
            overflow: hidden;
            border-bottom: 1px solid #3e3e42;
            margin-bottom: 15px;
        }

        .tab-link {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 8px 16px;
            transition: 0.3s;
            color: #cccccc;
            border-top: 2px solid transparent;
        }

        .tab-link:hover {
            background-color: #3e3e42;
        }

        .tab-link.active {
            background-color: #252526;
            border-top: 2px solid #007acc;
            border-bottom: 1px solid #252526;
            margin-bottom: -1px;
        }

        .tab-content {
            display: none;
            animation: fadeEffect 0.5s;
        }

        @keyframes fadeEffect {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Forms */
        fieldset {
            border: 1px solid #3e3e42;
            padding: 10px;
            margin-bottom: 15px;
        }

        legend {
            padding: 0 5px;
            color: #007acc;
        }

        .form-group {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .form-group label {
            width: 100px;
            display: inline-block;
        }

        .form-group input,
        .form-group select {
            flex: 1;
            padding: 4px;
            background-color: #3c3c3c;
            border: 1px solid #3e3e42;
            color: #cccccc;
        }

        .checkbox-group {
            margin-bottom: 5px;
        }

        .device-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
        }

        .device-table th,
        .device-table td {
            border: 1px solid #3e3e42;
            padding: 5px;
            text-align: left;
        }

        .device-table th {
            background-color: #2d2d30;
        }
    </style>

    <script>
        // Modal Functions
        function openTargetSettings() {
            document.getElementById('target-setup-modal').style.display = 'block';
            // Trigger detection info refresh
            ipcRenderer.send('get-target-info');
        }

        function closeTargetSettings() {
            document.getElementById('target-setup-modal').style.display = 'none';
        }

        function saveTargetSettings() {
            const settings = {
                clock: document.getElementById('target-clock').value,
                connect: document.getElementById('connect-mode').value,
                reset: document.getElementById('reset-mode').value,
                verify: document.getElementById('verify-code').checked,
                downloadToFlash: document.getElementById('download-to-flash').checked,
                resetRun: document.getElementById('reset-run').checked
            };
            ipcRenderer.send('save-target-settings', settings);
            closeTargetSettings();
        }

        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // IPC Listeners for Modal
        ipcRenderer.on('target-info-result', (event, data) => {
            if (data.stlink) {
                document.getElementById('adapter-serial').value = data.stlink.serial || 'Unknown';
                document.getElementById('adapter-fw').value = data.stlink.version || 'Unknown';
                // Try to guess version from string
                if (data.stlink.version && data.stlink.version.includes('V3')) {
                    document.getElementById('adapter-unit').value = 'ST-LINK/V3';
                }
            }

            const tbody = document.getElementById('detected-devices');
            if (data.chip) {
                tbody.innerHTML = `
                    <tr>
                        <td>${data.chip.idcode}</td>
                        <td>${data.chip.name || 'Unknown Cortex-M'}</td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = '<tr><td colspan="2">No device detected</td></tr>';
            }
        });

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('target-setup-modal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
</body>

</html>