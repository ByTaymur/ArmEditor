<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmEditor - Professional ARM IDE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #1e1e1e;
            color: #cccccc;
            overflow: hidden;
            height: 100vh;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* TOOLBAR */
        .toolbar {
            background: #2d2d30;
            padding: 8px 12px;
            display: flex;
            gap: 8px;
            align-items: center;
            border-bottom: 1px solid #3e3e42;
        }

        .btn {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #1177bb;
        }

        .btn:active {
            background: #0d5a8f;
        }

        .btn.success {
            background: #16825d;
        }

        .btn.success:hover {
            background: #1e9b70;
        }

        .btn.danger {
            background: #d13438;
        }

        .btn.danger:hover {
            background: #e13438;
        }

        .separator {
            width: 1px;
            height: 20px;
            background: #3e3e42;
            margin: 0 4px;
        }

        .project-name {
            color: #4fc1ff;
            font-weight: 600;
            margin-left: auto;
            font-size: 14px;
        }

        /* MAIN AREA */
        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* SIDEBAR - File Tree */
        .sidebar {
            width: 250px;
            background: #252526;
            border-right: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 12px;
            background: #2d2d30;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            color: #999;
            border-bottom: 1px solid #3e3e42;
        }

        .file-tree {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .file-item, .folder-item {
            padding: 6px 16px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
        }

        .file-item:hover, .folder-item:hover {
            background: #2a2d2e;
        }

        .file-item.active {
            background: #094771;
            color: #ffffff;
        }

        .file-icon {
            font-size: 16px;
        }

        .folder-icon {
            font-size: 16px;
            transition: transform 0.2s;
        }

        .folder-icon.collapsed {
            transform: rotate(-90deg);
        }

        .folder-children {
            display: none;
        }

        .folder-children.expanded {
            display: block;
        }

        /* EDITOR AREA */
        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-tabs {
            background: #2d2d30;
            display: flex;
            gap: 2px;
            padding: 4px 8px;
            border-bottom: 1px solid #3e3e42;
            overflow-x: auto;
        }

        .tab {
            background: #2d2d30;
            padding: 6px 12px;
            border-radius: 3px 3px 0 0;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .tab:hover {
            background: #1e1e1e;
        }

        .tab.active {
            background: #1e1e1e;
            color: #ffffff;
        }

        .tab-close {
            opacity: 0.6;
            font-size: 16px;
            margin-left: 8px;
        }

        .tab-close:hover {
            opacity: 1;
        }

        .editor {
            flex: 1;
            background: #1e1e1e;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #code-editor {
            width: 100%;
            height: 100%;
            background: #1e1e1e;
            color: #d4d4d4;
            border: none;
            padding: 16px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            outline: none;
        }

        .welcome {
            text-align: center;
            color: #6a6a6a;
        }

        .welcome h1 {
            font-size: 48px;
            margin-bottom: 16px;
            color: #4fc1ff;
        }

        .welcome p {
            font-size: 16px;
        }

        /* OUTPUT PANEL */
        .output-panel {
            height: 200px;
            background: #1e1e1e;
            border-top: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
        }

        .output-header {
            background: #2d2d30;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: #999;
            display: flex;
            gap: 12px;
        }

        .output-tab {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 3px;
        }

        .output-tab:hover {
            background: #3e3e42;
        }

        .output-tab.active {
            background: #094771;
            color: #ffffff;
        }

        #output {
            flex: 1;
            background: #1e1e1e;
            color: #cccccc;
            padding: 12px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            line-height: 1.4;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4e4e4e;
        }

        /* ST-LINK PANEL */
        .stlink-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .stlink-panel.show {
            display: flex;
        }

        .stlink-content {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            width: 700px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .stlink-header {
            background: #2d2d30;
            padding: 16px 20px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stlink-header h2 {
            margin: 0;
            font-size: 18px;
            color: #4fc1ff;
        }

        .stlink-close {
            background: none;
            border: none;
            color: #999;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .stlink-close:hover {
            color: #fff;
        }

        .stlink-body {
            padding: 20px;
            overflow-y: auto;
        }

        .stlink-device {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .stlink-device.connected {
            border-color: #16825d;
        }

        .stlink-device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .stlink-name {
            font-size: 16px;
            font-weight: 600;
            color: #4fc1ff;
        }

        .stlink-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .stlink-status.connected {
            background: #16825d;
            color: white;
        }

        .stlink-status.disconnected {
            background: #3e3e42;
            color: #999;
        }

        .stlink-info {
            font-size: 13px;
            line-height: 1.8;
            color: #cccccc;
            margin-bottom: 12px;
        }

        .stlink-info-row {
            display: flex;
            margin-bottom: 4px;
        }

        .stlink-info-label {
            min-width: 120px;
            color: #999;
        }

        .stlink-info-value {
            color: #d4d4d4;
            font-family: 'Consolas', monospace;
        }

        .stlink-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-connect {
            background: #16825d;
        }

        .btn-connect:hover {
            background: #1e9b70;
        }

        .btn-disconnect {
            background: #d13438;
        }

        .btn-disconnect:hover {
            background: #e13438;
        }

        .btn-refresh {
            background: #0e639c;
        }

        .btn-refresh:hover {
            background: #1177bb;
        }

        .no-devices {
            text-align: center;
            padding: 40px;
            color: #6a6a6a;
        }

        .no-devices h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- TOOLBAR -->
        <div class="toolbar">
            <button class="btn" onclick="openProject()">üìÅ Open Project</button>
            <button class="btn" onclick="saveFile()">üíæ Save (Ctrl+S)</button>
            <div class="separator"></div>
            <button class="btn success" onclick="buildProject()">üî® Build (F7)</button>
            <button class="btn" onclick="cleanProject()">üßπ Clean</button>
            <div class="separator"></div>
            <button class="btn success" onclick="flashDevice()">‚ö° Flash (F8)</button>
            <button class="btn danger" onclick="debugStart()">‚ñ∂Ô∏è Debug (F5)</button>
            <div class="separator"></div>
            <button class="btn" onclick="openStLinkPanel()">üîå ST-Link Manager</button>
            <div class="project-name" id="project-name">No Project</div>
        </div>

        <!-- MAIN AREA -->
        <div class="main">
            <!-- SIDEBAR - File Tree -->
            <div class="sidebar">
                <div class="sidebar-header">Files</div>
                <div class="file-tree" id="file-tree">
                    <div style="padding: 20px; text-align: center; color: #6a6a6a;">
                        Open a project to see files
                    </div>
                </div>
            </div>

            <!-- EDITOR AREA -->
            <div class="editor-area">
                <div class="editor-tabs" id="editor-tabs"></div>
                <div class="editor">
                    <div class="welcome" id="welcome">
                        <h1>üöÄ ArmEditor</h1>
                        <p>Professional ARM Development IDE</p>
                        <p style="margin-top: 20px; font-size: 14px;">Click <strong>Open Project</strong> to get started</p>
                    </div>
                    <textarea id="code-editor" style="display: none;"></textarea>
                </div>
            </div>
        </div>

        <!-- OUTPUT PANEL -->
        <div class="output-panel">
            <div class="output-header">
                <div class="output-tab active">Output</div>
            </div>
            <div id="output">Ready.</div>
        </div>
    </div>

    <!-- ST-LINK PANEL -->
    <div class="stlink-panel" id="stlink-panel">
        <div class="stlink-content">
            <div class="stlink-header">
                <h2>üîå ST-Link / Programmer Manager</h2>
                <button class="stlink-close" onclick="closeStLinkPanel()">‚úï</button>
            </div>
            <div class="stlink-body" id="stlink-body">
                <div style="text-align: center; padding: 20px;">
                    <p style="color: #999;">Scanning for ST-Link devices...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');

        let currentFile = null;
        let currentProject = null;
        let openTabs = [];
        let activeTab = -1;

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveFile();
            }
            if (e.key === 'F7') {
                e.preventDefault();
                buildProject();
            }
            if (e.key === 'F8') {
                e.preventDefault();
                flashDevice();
            }
            if (e.key === 'F5') {
                e.preventDefault();
                debugStart();
            }
        });

        // Open Project
        function openProject() {
            ipcRenderer.send('open-project-dialog');
        }

        // Save File
        function saveFile() {
            if (!currentFile) {
                outputAppend('‚ö†Ô∏è No file open\n');
                return;
            }

            const content = document.getElementById('code-editor').value;
            ipcRenderer.send('save-file', currentFile.path, content);
            outputAppend(`üíæ Saved: ${currentFile.name}\n`);

            // Update tab
            if (activeTab !== -1) {
                openTabs[activeTab].modified = false;
                updateTabs();
            }
        }

        // Build Project
        function buildProject() {
            if (!currentProject) {
                outputAppend('‚ö†Ô∏è No project open\n');
                return;
            }
            outputAppend('\nüî® Building project...\n');
            ipcRenderer.send('build-project');
        }

        // Clean Project
        function cleanProject() {
            if (!currentProject) {
                outputAppend('‚ö†Ô∏è No project open\n');
                return;
            }
            outputAppend('\nüßπ Cleaning...\n');
            ipcRenderer.send('clean-project');
        }

        // Flash Device
        function flashDevice() {
            if (!currentProject) {
                outputAppend('‚ö†Ô∏è No project open\n');
                return;
            }
            outputAppend('\n‚ö° Flashing device...\n');
            ipcRenderer.send('flash-program');
        }

        // Debug Start
        function debugStart() {
            if (!currentProject) {
                outputAppend('‚ö†Ô∏è No project open\n');
                return;
            }
            outputAppend('\n‚ñ∂Ô∏è Starting debug...\n');
            ipcRenderer.send('debug-start');
        }

        // Append to output
        function outputAppend(text) {
            const output = document.getElementById('output');
            output.textContent += text;
            output.scrollTop = output.scrollHeight;
        }

        // Update tabs
        function updateTabs() {
            const tabsContainer = document.getElementById('editor-tabs');
            tabsContainer.innerHTML = '';

            openTabs.forEach((tab, index) => {
                const tabEl = document.createElement('div');
                tabEl.className = 'tab' + (index === activeTab ? ' active' : '');

                const icon = getFileIcon(tab.name);
                const modified = tab.modified ? ' ‚Ä¢' : '';

                tabEl.innerHTML = `
                    <span class="file-icon">${icon}</span>
                    <span>${tab.name}${modified}</span>
                    <span class="tab-close" onclick="closeTab(${index}); event.stopPropagation();">‚úï</span>
                `;

                tabEl.onclick = () => switchToTab(index);
                tabsContainer.appendChild(tabEl);
            });
        }

        // Switch to tab
        function switchToTab(index) {
            if (index < 0 || index >= openTabs.length) return;

            // Save current content
            if (activeTab !== -1) {
                const content = document.getElementById('code-editor').value;
                openTabs[activeTab].content = content;
            }

            activeTab = index;
            currentFile = openTabs[index];

            // Load new content
            document.getElementById('code-editor').value = currentFile.content;
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('code-editor').style.display = 'block';

            updateTabs();
            updateFileTree();
        }

        // Close tab
        function closeTab(index) {
            if (openTabs[index].modified) {
                if (!confirm(`${openTabs[index].name} has unsaved changes. Close anyway?`)) {
                    return;
                }
            }

            openTabs.splice(index, 1);

            if (openTabs.length === 0) {
                activeTab = -1;
                currentFile = null;
                document.getElementById('welcome').style.display = 'flex';
                document.getElementById('code-editor').style.display = 'none';
            } else {
                if (activeTab >= openTabs.length) {
                    activeTab = openTabs.length - 1;
                }
                switchToTab(activeTab);
            }

            updateTabs();
        }

        // Open file
        function openFile(file) {
            // Check if already open
            const existingIndex = openTabs.findIndex(t => t.path === file.path);
            if (existingIndex !== -1) {
                switchToTab(existingIndex);
                return;
            }

            // Add new tab
            openTabs.push({
                path: file.path,
                name: file.name,
                content: file.content || '',
                modified: false
            });

            switchToTab(openTabs.length - 1);
        }

        // Get file icon
        function getFileIcon(name) {
            if (name.endsWith('.c')) return 'üìÑ';
            if (name.endsWith('.h')) return 'üìã';
            if (name.endsWith('.cpp') || name.endsWith('.cc')) return 'üìÑ';
            if (name.endsWith('.s') || name.endsWith('.asm')) return '‚öôÔ∏è';
            if (name.endsWith('.json')) return 'üì¶';
            if (name.endsWith('.md')) return 'üìù';
            return 'üìÑ';
        }

        // Update file tree with hierarchical folders
        function updateFileTree() {
            if (!currentProject) return;

            const tree = document.getElementById('file-tree');
            tree.innerHTML = '';

            if (currentProject.folders) {
                // Render hierarchical folder tree
                renderTreeNode(currentProject.folders, tree, 0);
            } else if (currentProject.files) {
                // Fallback to flat file list
                currentProject.files.forEach(file => {
                    const item = createFileItem(file, 0);
                    tree.appendChild(item);
                });
            }
        }

        // Render tree node recursively
        function renderTreeNode(node, container, level) {
            if (node.type === 'folder') {
                // Create folder item
                const folderDiv = document.createElement('div');

                const folderItem = document.createElement('div');
                folderItem.className = 'folder-item';
                folderItem.style.paddingLeft = (8 + level * 16) + 'px';

                const folderId = 'folder-' + Math.random().toString(36).substr(2, 9);
                folderItem.innerHTML = `
                    <span class="folder-icon" id="${folderId}-icon">üìÇ</span>
                    <span>${node.name}</span>
                `;

                const childrenDiv = document.createElement('div');
                childrenDiv.className = 'folder-children expanded';
                childrenDiv.id = folderId + '-children';

                // Toggle folder
                folderItem.onclick = (e) => {
                    e.stopPropagation();
                    const icon = document.getElementById(folderId + '-icon');
                    const children = document.getElementById(folderId + '-children');

                    if (children.classList.contains('expanded')) {
                        children.classList.remove('expanded');
                        icon.textContent = 'üìÅ';
                        icon.classList.add('collapsed');
                    } else {
                        children.classList.add('expanded');
                        icon.textContent = 'üìÇ';
                        icon.classList.remove('collapsed');
                    }
                };

                folderDiv.appendChild(folderItem);
                folderDiv.appendChild(childrenDiv);
                container.appendChild(folderDiv);

                // Render children
                if (node.children && node.children.length > 0) {
                    node.children.forEach(child => {
                        renderTreeNode(child, childrenDiv, level + 1);
                    });
                }
            } else if (node.type === 'file') {
                // Create file item
                const fileItem = createFileItem(node, level);
                container.appendChild(fileItem);
            }
        }

        // Create file item
        function createFileItem(file, level) {
            const item = document.createElement('div');
            item.className = 'file-item';
            item.style.paddingLeft = (8 + level * 16) + 'px';

            if (currentFile && currentFile.path === file.path) {
                item.classList.add('active');
            }

            const icon = getFileIcon(file.name);
            item.innerHTML = `
                <span class="file-icon">${icon}</span>
                <span>${file.name}</span>
            `;

            item.onclick = () => {
                ipcRenderer.send('read-file', file.path);
            };

            return item;
        }

        // Track modifications
        document.getElementById('code-editor').addEventListener('input', () => {
            if (activeTab !== -1) {
                openTabs[activeTab].modified = true;
                openTabs[activeTab].content = document.getElementById('code-editor').value;
                updateTabs();
            }
        });

        // IPC Listeners
        ipcRenderer.on('project-opened', (event, project) => {
            currentProject = project;
            document.getElementById('project-name').textContent = project.name;
            outputAppend(`‚úÖ Opened project: ${project.name}\n`);
            outputAppend(`   Files: ${project.files.length}\n`);
            updateFileTree();
        });

        ipcRenderer.on('file-content', (event, data) => {
            openFile({
                path: data.path,
                name: data.name,
                content: data.content
            });
        });

        ipcRenderer.on('output-append', (event, text) => {
            outputAppend(text);
        });

        ipcRenderer.on('output-clear', () => {
            document.getElementById('output').textContent = '';
        });

        // ST-LINK PANEL FUNCTIONS
        function openStLinkPanel() {
            document.getElementById('stlink-panel').classList.add('show');
            refreshStLinks();
        }

        function closeStLinkPanel() {
            document.getElementById('stlink-panel').classList.remove('show');
        }

        function refreshStLinks() {
            document.getElementById('stlink-body').innerHTML = '<div style="text-align: center; padding: 20px;"><p style="color: #999;">Scanning...</p></div>';
            ipcRenderer.send('scan-stlinks');
        }

        function connectStLink(deviceId) {
            ipcRenderer.send('connect-stlink', deviceId);
        }

        function disconnectStLink(deviceId) {
            ipcRenderer.send('disconnect-stlink', deviceId);
        }

        // ST-Link devices updated
        ipcRenderer.on('stlink-devices', (event, devices) => {
            const body = document.getElementById('stlink-body');

            if (!devices || devices.length === 0) {
                body.innerHTML = `
                    <div class="no-devices">
                        <h3>No ST-Link Detected</h3>
                        <p>Please connect your ST-Link/V2/V3 and click refresh</p>
                        <button class="btn btn-refresh" onclick="refreshStLinks()" style="margin-top: 16px;">üîÑ Refresh</button>
                    </div>
                `;
                return;
            }

            let html = '';
            devices.forEach(device => {
                const connected = device.connected ? 'connected' : 'disconnected';
                const statusText = device.connected ? 'Connected' : 'Disconnected';

                html += `
                    <div class="stlink-device ${connected}">
                        <div class="stlink-device-header">
                            <div class="stlink-name">${device.name}</div>
                            <div class="stlink-status ${connected}">${statusText}</div>
                        </div>
                        <div class="stlink-info">
                            <div class="stlink-info-row">
                                <div class="stlink-info-label">USB ID:</div>
                                <div class="stlink-info-value">${device.usbId}</div>
                            </div>
                            ${device.serial ? `
                            <div class="stlink-info-row">
                                <div class="stlink-info-label">Serial Number:</div>
                                <div class="stlink-info-value">${device.serial}</div>
                            </div>` : ''}
                            ${device.mcu ? `
                            <div class="stlink-info-row">
                                <div class="stlink-info-label">MCU Detected:</div>
                                <div class="stlink-info-value">${device.mcu.name || 'Unknown'}</div>
                            </div>
                            <div class="stlink-info-row">
                                <div class="stlink-info-label">Device ID:</div>
                                <div class="stlink-info-value">${device.mcu.deviceId || 'N/A'}</div>
                            </div>
                            <div class="stlink-info-row">
                                <div class="stlink-info-label">Flash Size:</div>
                                <div class="stlink-info-value">${device.mcu.flashSize || 'N/A'}</div>
                            </div>` : ''}
                        </div>
                        <div class="stlink-actions">
                            ${!device.connected ? `
                                <button class="btn btn-connect" onclick="connectStLink('${device.id}')">üîå Connect</button>
                            ` : `
                                <button class="btn btn-disconnect" onclick="disconnectStLink('${device.id}')">üî¥ Disconnect</button>
                            `}
                            <button class="btn btn-refresh" onclick="refreshStLinks()">üîÑ Refresh</button>
                        </div>
                    </div>
                `;
            });

            body.innerHTML = html;
        });

        console.log('‚úÖ ArmEditor UI loaded');
    </script>
</body>
</html>
